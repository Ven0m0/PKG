# Lefthook configuration for PKG repository
# Install: curl -1sLf 'https://dl.cloudsmith.io/public/evilmartians/lefthook/setup.rpm.sh' | sudo -E bash && sudo yum install lefthook
# Or: brew install lefthook (macOS)
# Or: go install github.com/evilmartians/lefthook@latest
# Setup: lefthook install
# Run manually: lefthook run pre-commit

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Pre-commit Hooks
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

pre-commit:
  parallel: true

  commands:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Shell Script Linting & Formatting
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    shellcheck:
      tags: [shell, lint]
      glob: "*.sh"
      exclude: "^(wine-tkg-git|chromium)/"
      run: |
        if command -v shellcheck &>/dev/null; then
          shellcheck -x -a -s bash {staged_files}
        else
          echo "âš ï¸  shellcheck not found, skipping..."
        fi

    shellcheck-pkgbuild:
      tags: [pkgbuild, lint]
      glob: "**/PKGBUILD"
      run: |
        if command -v shellcheck &>/dev/null; then
          shellcheck -x -a -s bash {staged_files}
        else
          echo "âš ï¸  shellcheck not found, skipping..."
        fi

    shfmt:
      tags: [shell, format]
      glob: "*.sh"
      run: |
        if command -v shfmt &>/dev/null; then
          shfmt -ln bash -bn -ci -s -i 2 -w {staged_files}
        else
          echo "âš ï¸  shfmt not found, skipping..."
        fi

    shfmt-pkgbuild:
      tags: [pkgbuild, format]
      glob: "**/PKGBUILD"
      run: |
        if command -v shfmt &>/dev/null; then
          shfmt -ln bash -bn -ci -s -i 2 -w {staged_files}
        else
          echo "âš ï¸  shfmt not found, skipping..."
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PKGBUILD Specific Checks
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    pkgbuild-srcinfo:
      tags: [pkgbuild, validation]
      glob: "**/PKGBUILD"
      run: |
        for pkgbuild in {staged_files}; do
          dir=$(dirname "$pkgbuild")
          if [[ -f "$dir/.SRCINFO" ]]; then
            cd "$dir" || exit 1
            if ! makepkg --printsrcinfo 2>/dev/null | diff -q .SRCINFO - >/dev/null 2>&1; then
              echo "âŒ ERROR: .SRCINFO out of sync in $dir"
              echo "   Run: cd $dir && makepkg --printsrcinfo > .SRCINFO"
              exit 1
            fi
            cd - >/dev/null || exit 1
          fi
        done

    namcap:
      tags: [pkgbuild, lint]
      glob: "**/PKGBUILD"
      run: |
        if command -v namcap &>/dev/null; then
          for pkgbuild in {staged_files}; do
            namcap "$pkgbuild" || echo "âš ï¸  namcap warnings in $pkgbuild"
          done
        else
          echo "âš ï¸  namcap not found, skipping..."
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # General Code Quality
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    trailing-whitespace:
      tags: [formatting]
      glob: "*.{sh,md,yml,yaml,json,txt}"
      exclude: "\\.(patch|diff)$"
      run: |
        for file in {staged_files}; do
          if grep -q '[[:space:]]$' "$file" 2>/dev/null; then
            sed -i 's/[[:space:]]*$//' "$file"
            echo "âœ“ Fixed trailing whitespace in $file"
            git add "$file"
          fi
        done

    end-of-file:
      tags: [formatting]
      glob: "*.{sh,md,yml,yaml,json,txt,toml}"
      exclude: "\\.(patch|diff)$"
      run: |
        for file in {staged_files}; do
          if [[ -f "$file" && -s "$file" ]]; then
            if [[ $(tail -c1 "$file" | wc -l) -eq 0 ]]; then
              echo "" >> "$file"
              echo "âœ“ Added final newline to $file"
              git add "$file"
            fi
          fi
        done

    yaml-lint:
      tags: [yaml, lint]
      glob: "*.{yml,yaml}"
      run: |
        if command -v yamllint &>/dev/null; then
          yamllint {staged_files}
        else
          echo "âš ï¸  yamllint not found, skipping..."
        fi

    json-lint:
      tags: [json, lint]
      glob: "*.json"
      run: |
        for file in {staged_files}; do
          if ! jq empty "$file" 2>/dev/null; then
            echo "âŒ Invalid JSON in $file"
            exit 1
          fi
        done

    check-merge-conflict:
      tags: [git]
      run: |
        if git diff --cached --name-only | xargs grep -l "^<<<<<<< \|^=======$\|^>>>>>>> " 2>/dev/null; then
          echo "âŒ Merge conflict markers found!"
          exit 1
        fi

    check-executables:
      tags: [permissions]
      glob: "*.sh"
      run: |
        for file in {staged_files}; do
          if [[ -f "$file" ]] && head -n1 "$file" | grep -q '^#!'; then
            if [[ ! -x "$file" ]]; then
              chmod +x "$file"
              echo "âœ“ Made $file executable"
              git add "$file"
            fi
          fi
        done

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # EditorConfig Compliance
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    editorconfig:
      tags: [formatting]
      glob: "*.{sh,md,yml,yaml,json,txt,toml}"
      exclude: "\\.(patch|diff|\\.min\\.(js|css))$"
      run: |
        if command -v editorconfig-checker &>/dev/null || command -v ec &>/dev/null; then
          ec {staged_files} || editorconfig-checker {staged_files}
        else
          echo "âš ï¸  editorconfig-checker not found, skipping..."
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Markdown Linting
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    markdownlint:
      tags: [markdown, lint]
      glob: "*.md"
      run: |
        if command -v markdownlint &>/dev/null; then
          markdownlint --fix {staged_files} && git add {staged_files}
        else
          echo "âš ï¸  markdownlint not found, skipping..."
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Security Checks
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    detect-secrets:
      tags: [security]
      run: |
        if command -v detect-secrets &>/dev/null; then
          detect-secrets scan {staged_files}
        else
          echo "âš ï¸  detect-secrets not found, skipping..."
        fi

    check-large-files:
      tags: [performance]
      run: |
        for file in {staged_files}; do
          if [[ -f "$file" ]]; then
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            if [[ $size -gt 10485760 ]]; then  # 10MB
              echo "âŒ File too large: $file ($(numfmt --to=iec $size))"
              exit 1
            fi
          fi
        done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Pre-push Hooks
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

pre-push:
  parallel: false

  commands:
    run-tests:
      tags: [test]
      run: |
        if [[ -f "./pkg.sh" ]]; then
          echo "ğŸ” Running pkg.sh lint..."
          ./pkg.sh lint
        fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Commit Message Validation
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

commit-msg:
  commands:
    conventional-commits:
      tags: [commit-msg]
      run: |
        msg=$(cat {1})
        # Check for conventional commit format
        if ! echo "$msg" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+'; then
          echo "âŒ Commit message doesn't follow conventional commits format"
          echo "   Format: <type>(<scope>): <subject>"
          echo "   Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          echo ""
          echo "   Your message:"
          echo "   $msg"
          exit 1
        fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Skip Patterns
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

skip_output:
  - meta
  - summary

output:
  - summary
  - success

colors: true
