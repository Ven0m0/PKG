#!/usr/bin/env bash
# Maintainer: Ven0m0 <https://github.com/Ven0m0/PKG>
# Contributor: loathingkernel <loathingkernel @at gmail .dot com>
# Contributor: pythonlover02

# Build variant: 'gplasync' (default, for Vulkan 1.3+ GPUs) or 'sarek' (for older GPUs)
_variant=${_variant:-gplasync}

if [[ "${_variant}" == "sarek" ]]; then
  pkgname=dxvk-sarek
  pkgver=1.11.0
  pkgdesc='Vulkan-based D3D8/9/10/11 implementation for older GPUs without Vulkan 1.3 support (Sarek fork)'
  url='https://github.com/pythonlover02/DXVK-Sarek'
  _commit='b8bb58e6c8db5c08f7b56e90b88834f0b3e16ff1'  # v1.11.0
  _srcdir='DXVK-Sarek'
  _conf_file='dxvk-sarek.conf'
  _bin_name='setup_dxvk_sarek'
  source=(
    "git+https://github.com/pythonlover02/DXVK-Sarek.git#commit=${_commit}"
    'dxvk-sarek.conf'
    'dxvk-extraopts.patch'
    'setup_dxvk.sh'
  )
  sha256sums=(
    'SKIP'
    'SKIP'
    'SKIP'
    'SKIP'
  )
else
  pkgname=dxvk-gplasync-lowlatency
  pkgver=2.7.1
  pkgdesc='Vulkan-based implementation of D3D8/9/10/11 with GPL Async and Low Latency features'
  url='https://github.com/Digger1955/dxvk-gplasync-lowlatency'
  _srcdir='dxvk-gplasync-lowlatency'
  _conf_file='dxvk-async.conf'
  _bin_name='setup_dxvk'
  source=(
    "git+https://github.com/Digger1955/dxvk-gplasync-lowlatency.git#tag=v${pkgver}"
    'dxvk-async.conf'
    'setup_dxvk.sh'
  )
  sha256sums=(
    'SKIP'
    'SKIP'
    'SKIP'
  )
fi

pkgrel=1
arch=('x86_64')
license=('Zlib')
depends=('vulkan-icd-loader' 'lib32-vulkan-icd-loader' 'wine' 'bash')
makedepends=('ninja' 'meson>=0.49' 'glslang' 'git' 'mingw-w64-gcc')
provides=('dxvk' 'd3d8' 'd3d9' 'd3d10' 'd3d11' 'dxgi')
conflicts=('dxvk' 'dxvk-gplasync-lowlatency' 'dxvk-sarek')
options=(!lto !staticlibs)

prepare() {
  cd "${_srcdir}"

  # Apply Sarek optimization patch if building Sarek variant
  if [[ "${_variant}" == "sarek" ]]; then
    patch -Np1 -i ../dxvk-extraopts.patch
  fi

  # Explicitly set origin URL for submodules using relative paths
  git remote set-url origin "${url}"
  git submodule update --init --filter=tree:0 --recursive
}

build() {
  export CFLAGS="${CFLAGS/-O2/-O3} -pipe -fno-plt -fstack-protector-strong"
  export CXXFLAGS="${CXXFLAGS/-O2/-O3} -pipe -fno-plt -fstack-protector-strong"
  export LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"

  # Build 64-bit
  arch-meson "${_srcdir}" build64 \
    --cross-file "${_srcdir}/build-win64.txt" \
    --buildtype "release" \
    --strip \
    --bindir "x64" \
    --libdir "x64" \
    -Denable_tests=false \
    -Denable_dxgi=true \
    -Denable_d3d9=true \
    -Denable_d3d10=true \
    -Denable_d3d11=true

  ninja -C build64 -v

  # Build 32-bit
  arch-meson "${_srcdir}" build32 \
    --cross-file "${_srcdir}/build-win32.txt" \
    --buildtype "release" \
    --strip \
    --bindir "x32" \
    --libdir "x32" \
    -Denable_tests=false \
    -Denable_dxgi=true \
    -Denable_d3d9=true \
    -Denable_d3d10=true \
    -Denable_d3d11=true

  ninja -C build32 -v
}

package() {
  install -d "${pkgdir}/usr/share/${pkgname}"

  # Install 64-bit libraries
  install -Dm755 build64/src/dxgi/dxgi.dll "${pkgdir}/usr/share/${pkgname}/x64/dxgi.dll"
  install -Dm755 build64/src/d3d8/d3d8.dll "${pkgdir}/usr/share/${pkgname}/x64/d3d8.dll"
  install -Dm755 build64/src/d3d9/d3d9.dll "${pkgdir}/usr/share/${pkgname}/x64/d3d9.dll"
  install -Dm755 build64/src/d3d10/d3d10core.dll "${pkgdir}/usr/share/${pkgname}/x64/d3d10core.dll"
  install -Dm755 build64/src/d3d11/d3d11.dll "${pkgdir}/usr/share/${pkgname}/x64/d3d11.dll"

  # Install 32-bit libraries
  install -Dm755 build32/src/dxgi/dxgi.dll "${pkgdir}/usr/share/${pkgname}/x32/dxgi.dll"
  install -Dm755 build32/src/d3d8/d3d8.dll "${pkgdir}/usr/share/${pkgname}/x32/d3d8.dll"
  install -Dm755 build32/src/d3d9/d3d9.dll "${pkgdir}/usr/share/${pkgname}/x32/d3d9.dll"
  install -Dm755 build32/src/d3d10/d3d10core.dll "${pkgdir}/usr/share/${pkgname}/x32/d3d10core.dll"
  install -Dm755 build32/src/d3d11/d3d11.dll "${pkgdir}/usr/share/${pkgname}/x32/d3d11.dll"

  # Install setup script
  install -Dm755 "${srcdir}/setup_dxvk.sh" "${pkgdir}/usr/share/${pkgname}/setup_dxvk.sh"

  # Install configuration
  install -Dm644 "${srcdir}/${_conf_file}" "${pkgdir}/etc/environment.d/${_conf_file}"

  # Install license
  install -Dm644 "${_srcdir}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  # Create compatibility symlinks
  ln -s "/usr/share/${pkgname}/setup_dxvk.sh" "${pkgdir}/usr/bin/${_bin_name}"
}
