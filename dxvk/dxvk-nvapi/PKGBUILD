#!/usr/bin/env bash
# Maintainer: Ven0m0 <https://github.com/Ven0m0/PKG>
# Contributor: loathingkernel <loathingkernel @at gmail .dot com>

pkgname=dxvk-nvapi-vkreflex-layer
pkgver=0.9.0
pkgrel=1
pkgdesc='Alternative NVAPI implementation on top of DXVK with Vulkan Reflex layer for NVIDIA features'
arch=('x86_64')
url='https://github.com/jp7677/dxvk-nvapi'
license=('MIT')
makedepends=('ninja' 'meson>=0.43' 'glslang' 'git')
depends=('vulkan-icd-loader' 'lib32-vulkan-icd-loader' 'bash')
source=(
  "git+https://github.com/jp7677/dxvk-nvapi.git#tag=v${pkgver}"
  'dxvk-env.conf'
  'dxvk-nvapi-extraopts.patch'
  'setup_dxvk_proton.sh'
  'setup_dxvk.sh'
)
sha256sums=(
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
)

prepare() {
  cd dxvk-nvapi

  # Explicitly set origin URL for submodules using relative paths
  git remote set-url origin "${url}"
  git submodule update --init --filter=tree:0 --recursive external/{Vulkan-Headers,vkroots}

  # Apply extra optimization patch
  patch -Np1 -i "${srcdir}/dxvk-nvapi-extraopts.patch"
}

build() {
  export CFLAGS="${CFLAGS/-O2/-O3} -pipe -fno-plt -fstack-protector-strong"
  export CXXFLAGS="${CXXFLAGS/-O2/-O3} -pipe -fno-plt -fstack-protector-strong"
  export LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"

  arch-meson dxvk-nvapi/layer build \
    --buildtype "release" \
    --strip \
    -Dabsolute_library_path=false

  ninja -C build -v
}

package() {
  DESTDIR="${pkgdir}" ninja -C build install

  # Install environment configuration
  install -dm755 "${pkgdir}/etc/environment.d"
  install -Dm644 "${srcdir}/dxvk-env.conf" "${pkgdir}/etc/environment.d/dxvk-nvapi.conf"

  # Install setup scripts
  install -dm755 "${pkgdir}/usr/share/${pkgname}"
  install -Dm755 "${srcdir}/setup_dxvk.sh" "${pkgdir}/usr/share/${pkgname}/setup_dxvk.sh"
  install -Dm755 "${srcdir}/setup_dxvk_proton.sh" "${pkgdir}/usr/share/${pkgname}/setup_dxvk_proton.sh"

  # Install license
  install -Dm644 dxvk-nvapi/LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  # Create compatibility symlinks
  ln -s "/usr/share/${pkgname}/setup_dxvk.sh" "${pkgdir}/usr/bin/setup_dxvk_nvapi"
}
