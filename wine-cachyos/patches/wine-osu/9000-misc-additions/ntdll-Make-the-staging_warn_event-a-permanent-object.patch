From 285eb1f534b211ce34cf81b687eb96d4bcf454a1 Mon Sep 17 00:00:00 2001
From: William Horvath <william@horvath.blog>
Date: Wed, 2 Apr 2025 00:27:23 -0700
Subject: [PATCH] ntdll: Make the staging_warn_event a permanent object.

Avoids printing it repeatedly.
---
 dlls/ntdll/loader.c | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/dlls/ntdll/loader.c b/dlls/ntdll/loader.c
index 9a960aa8c3c..dc55371c982 100644
--- a/dlls/ntdll/loader.c
+++ b/dlls/ntdll/loader.c
@@ -4627,7 +4627,7 @@ void loader_init( CONTEXT *context, void **entry )
 {
     OBJECT_ATTRIBUTES staging_event_attr;
     UNICODE_STRING staging_event_string;
-    HANDLE staging_event;
+    HANDLE staging_event = 0;
     static int attach_done;
     NTSTATUS status;
     ULONG_PTR cookie, port = 0;
@@ -4722,17 +4722,16 @@ void loader_init( CONTEXT *context, void **entry )
          * add a comment here to try to prevent that. */
     }
     RtlInitUnicodeString( &staging_event_string, L"\\__wine_staging_warn_event" );
-    InitializeObjectAttributes( &staging_event_attr, &staging_event_string, OBJ_OPENIF, NULL, NULL );
+    InitializeObjectAttributes( &staging_event_attr, &staging_event_string, OBJ_OPENIF | OBJ_PERMANENT, NULL, NULL );
     if (NtCreateEvent( &staging_event, EVENT_ALL_ACCESS, &staging_event_attr, NotificationEvent, FALSE ) == STATUS_SUCCESS)
     {
         FIXME_(winediag)("wine-staging %s is a testing version containing experimental patches.\n", wine_get_version());
         FIXME_(winediag)("Please mention your exact version when filing bug reports on winehq.org.\n");
     }
     else
-    {
         WARN_(winediag)("wine-staging %s is a testing version containing experimental patches.\n", wine_get_version());
-        NtClose( staging_event );
-    }
+
+    NtClose( staging_event );
 
     NtCurrentTeb()->FlsSlots = fls_alloc_data();
 
-- 
2.49.0
