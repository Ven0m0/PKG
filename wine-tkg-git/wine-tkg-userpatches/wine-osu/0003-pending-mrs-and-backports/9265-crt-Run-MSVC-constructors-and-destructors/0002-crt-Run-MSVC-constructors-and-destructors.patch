From 7931a4f941901b8914c5c8f6a09794134405a7c2 Mon Sep 17 00:00:00 2001
From: Yuxuan Shui <yshui@codeweavers.com>
Date: Wed, 3 Dec 2025 12:52:00 +0000
Subject: [PATCH] crt: Run MSVC constructors and destructors.

---
 dlls/msvcr100/Makefile.in   |  1 +
 dlls/msvcr110/Makefile.in   |  1 +
 dlls/msvcr120/Makefile.in   |  1 +
 dlls/msvcr70/Makefile.in    |  1 +
 dlls/msvcr71/Makefile.in    |  1 +
 dlls/msvcr80/Makefile.in    |  1 +
 dlls/msvcr90/Makefile.in    |  1 +
 dlls/msvcrt/Makefile.in     |  1 +
 dlls/msvcrt/crt_init.c      | 51 +++++++++++++++++++++++++++++++++++++
 dlls/msvcrt/crt_main.c      |  2 ++
 dlls/msvcrt/crt_wmain.c     |  2 ++
 dlls/ucrtbase/Makefile.in   |  1 +
 dlls/winecrt0/crt_dllmain.c | 50 +++++++++++++++++++++++++++++++++++-
 13 files changed, 113 insertions(+), 1 deletion(-)
 create mode 100644 dlls/msvcrt/crt_init.c

diff --git a/dlls/msvcr100/Makefile.in b/dlls/msvcr100/Makefile.in
index a0a3f64d6bf..34182e69f19 100644
--- a/dlls/msvcr100/Makefile.in
+++ b/dlls/msvcr100/Makefile.in
@@ -10,6 +10,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcr110/Makefile.in b/dlls/msvcr110/Makefile.in
index e6798427795..fdbcba054d4 100644
--- a/dlls/msvcr110/Makefile.in
+++ b/dlls/msvcr110/Makefile.in
@@ -10,6 +10,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcr120/Makefile.in b/dlls/msvcr120/Makefile.in
index b233753fa2e..3465d77a31e 100644
--- a/dlls/msvcr120/Makefile.in
+++ b/dlls/msvcr120/Makefile.in
@@ -10,6 +10,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcr70/Makefile.in b/dlls/msvcr70/Makefile.in
index 9413738ae1f..be93d88764b 100644
--- a/dlls/msvcr70/Makefile.in
+++ b/dlls/msvcr70/Makefile.in
@@ -9,6 +9,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcr71/Makefile.in b/dlls/msvcr71/Makefile.in
index 6e0b855cac3..c59ce97e8e4 100644
--- a/dlls/msvcr71/Makefile.in
+++ b/dlls/msvcr71/Makefile.in
@@ -9,6 +9,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcr80/Makefile.in b/dlls/msvcr80/Makefile.in
index 2a84383f79d..78accf161e9 100644
--- a/dlls/msvcr80/Makefile.in
+++ b/dlls/msvcr80/Makefile.in
@@ -9,6 +9,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcr90/Makefile.in b/dlls/msvcr90/Makefile.in
index d476d2e3080..3dfc080e554 100644
--- a/dlls/msvcr90/Makefile.in
+++ b/dlls/msvcr90/Makefile.in
@@ -9,6 +9,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcrt/Makefile.in b/dlls/msvcrt/Makefile.in
index aa068b62e51..a4023568d71 100644
--- a/dlls/msvcrt/Makefile.in
+++ b/dlls/msvcrt/Makefile.in
@@ -9,6 +9,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/msvcrt/crt_init.c b/dlls/msvcrt/crt_init.c
new file mode 100644
index 00000000000..5dc64c5882b
--- /dev/null
+++ b/dlls/msvcrt/crt_init.c
@@ -0,0 +1,51 @@
+/* Utility functions for calling MSVC/MingW ctors & dtors from mainCRTStartup. */
+
+#if 0
+#pragma makedep implib
+#endif
+
+#include <process.h>
+#include <stdlib.h>
+#include "minwindef.h"
+
+extern _PIFV __xi_a[];
+extern _PIFV __xi_z[];
+extern _PVFV __xc_a[];
+extern _PVFV __xc_z[];
+extern _PVFV __xt_a[];
+extern _PVFV __xt_z[];
+
+static inline int INIT_initterm_e(_PIFV *table, _PIFV *end)
+{
+#if _MSVCR_VER<80
+    int res = 0;
+
+    while (!res && table < end) {
+        if (*table)
+            res = (**table)();
+        table++;
+    }
+    return res;
+#else
+    return _initterm_e(table, end);
+#endif
+}
+
+void CDECL _initterm(_PVFV *,_PVFV *);
+
+static __cdecl void do_global_dtors(void)
+{
+    _initterm(__xt_a, __xt_z);
+}
+
+void do_global_ctors(void)
+{
+    if (INIT_initterm_e(__xi_a, __xi_z) != 0) return;
+    _initterm(__xc_a, __xc_z);
+
+#ifdef _UCRT
+    _crt_atexit(do_global_dtors);
+#else
+    _onexit((_onexit_t)do_global_dtors);
+#endif
+}
diff --git a/dlls/msvcrt/crt_main.c b/dlls/msvcrt/crt_main.c
index eb785e30bb0..5eb9e5032a0 100644
--- a/dlls/msvcrt/crt_main.c
+++ b/dlls/msvcrt/crt_main.c
@@ -31,6 +31,7 @@
 #include "winternl.h"
 
 int __cdecl main(int argc, char **argv, char **env);
+void do_global_ctors( void );
 
 static const IMAGE_NT_HEADERS *get_nt_header( void )
 {
@@ -54,6 +55,7 @@ int __cdecl mainCRTStartup(void)
     __getmainargs(&argc, &argv, &env, 0, &new_mode);
 #endif
     _set_app_type(get_nt_header()->OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI ? _crt_gui_app : _crt_console_app);
+    do_global_ctors();
 
     ret = main(argc, argv, env);
 
diff --git a/dlls/msvcrt/crt_wmain.c b/dlls/msvcrt/crt_wmain.c
index 79755d1a6e9..71cc0e48ec7 100644
--- a/dlls/msvcrt/crt_wmain.c
+++ b/dlls/msvcrt/crt_wmain.c
@@ -31,6 +31,7 @@
 #include "winternl.h"
 
 int __cdecl wmain(int argc, WCHAR **argv, WCHAR **env);
+void do_global_ctors(void);
 
 static const IMAGE_NT_HEADERS *get_nt_header( void )
 {
@@ -54,6 +55,7 @@ int __cdecl wmainCRTStartup(void)
     __wgetmainargs(&argc, &argv, &env, 0, &new_mode);
 #endif
     _set_app_type(get_nt_header()->OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI ? _crt_gui_app : _crt_console_app);
+    do_global_ctors();
 
     ret = wmain(argc, argv, env);
 
diff --git a/dlls/ucrtbase/Makefile.in b/dlls/ucrtbase/Makefile.in
index a3bb54750af..1bd1073dcf1 100644
--- a/dlls/ucrtbase/Makefile.in
+++ b/dlls/ucrtbase/Makefile.in
@@ -9,6 +9,7 @@ SOURCES = \
 	console.c \
 	cpp.c \
 	crt_gccmain.c \
+	crt_init.c \
 	crt_main.c \
 	crt_winmain.c \
 	crt_wmain.c \
diff --git a/dlls/winecrt0/crt_dllmain.c b/dlls/winecrt0/crt_dllmain.c
index 181760c884a..0b27189b98c 100644
--- a/dlls/winecrt0/crt_dllmain.c
+++ b/dlls/winecrt0/crt_dllmain.c
@@ -22,12 +22,60 @@
 
 #include <stdarg.h>
 #include <stdio.h>
+#include <process.h>
 #include "windef.h"
 #include "winbase.h"
 
+extern _PIFV __xi_a[];
+extern _PIFV __xi_z[];
+extern _PVFV __xc_a[];
+extern _PVFV __xc_z[];
+extern _PVFV __xt_a[];
+extern _PVFV __xt_z[];
+
+static inline void initterm( _PVFV *start,_PVFV *end )
+{
+  _PVFV* current = start;
+
+  while (current<end)
+  {
+    if (*current)
+      (**current)();
+    current++;
+  }
+}
+
+static inline int initterm_e( _PIFV *table, _PIFV *end )
+{
+    int res = 0;
+
+    while (!res && table < end) {
+        if (*table)
+            res = (**table)();
+        table++;
+    }
+    return res;
+}
+
+static void do_global_ctors(void)
+{
+    if (initterm_e( __xi_a, __xi_z ) != 0) return;
+    initterm( __xc_a, __xc_z );
+}
+
+
+static void do_global_dtors(void)
+{
+    initterm( __xt_a, __xt_z );
+}
+
 BOOL WINAPI DllMainCRTStartup( HINSTANCE inst, DWORD reason, void *reserved )
 {
-    return DllMain( inst, reason, reserved );
+    BOOL ret;
+    if (reason == DLL_PROCESS_ATTACH) do_global_ctors();
+    ret = DllMain( inst, reason, reserved );
+    if (reason == DLL_PROCESS_DETACH) do_global_dtors();
+    return ret;
 }
 
 #endif
-- 
GitLab

