# Maintainer: Ven0m0
pkgbase=curl
pkgname=('curl-rustls' 'curl-openssl' 'curl-wolfssl')
pkgver=8.11.0
pkgrel=1
arch=('x86_64')
url='https://curl.se/'
license=('MIT')
options=('strip')
makedepends=('openssl' 'rustls' 'wolfssl' 'pkg-config' 'autoconf' 'automake' 'libtool' 'quiche')
source=("https://curl.se/download/curl-${pkgver}.tar.xz")
sha256sums=('SKIP')

prepare() {
  cd "curl-$pkgver"
  autoreconf -fi
}

build() {
  cd "curl-$pkgver"
  export CFLAGS="-O3 -march=native -mtune=native -flto=auto -ffat-lto-objects -pipe -fno-plt"
  export LDFLAGS="-flto=auto -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now,-z,pack-relative-relocs"
  local -A tls=(
    [rustls]="--with-rustls"
    [openssl]="--with-openssl"
    [wolfssl]="--with-wolfssl"
  )
  for b in rustls openssl wolfssl; do
    mkdir -p "build-$b"
    cd "build-$b"
    ../configure \
      --prefix=/usr \
      --disable-shared \
      --disable-manual \
      --enable-ipv6 \
      --enable-threaded-resolver \
      --enable-http2 \
      --enable-quic \
      --with-quiche \
      --with-zlib \
      --with-brotli \
      --with-zstd \
      ${tls[$b]}
    make -j"$(nproc)"
    cd ..
  done
}

package_curl-rustls() {
  pkgdesc="URL transfer (rustls TLS + HTTP/3)"
  depends=('ca-certificates' 'brotli' 'librustls' 'zlib' 'zstd' 'quiche')
  provides=('curl')
  conflicts=('curl' 'curl-openssl' 'curl-wolfssl')
  cd "curl-$pkgver/build-rustls"
  make DESTDIR="$pkgdir" install
}

package_curl-openssl() {
  pkgdesc="URL transfer (OpenSSL TLS + HTTP/3)"
  depends=('ca-certificates' 'brotli' 'openssl' 'zlib' 'zstd' 'quiche')
  provides=('curl')
  conflicts=('curl' 'curl-rustls' 'curl-wolfssl')
  cd "curl-$pkgver/build-openssl"
  make DESTDIR="$pkgdir" install
}

package_curl-wolfssl() {
  pkgdesc="URL transfer (wolfSSL TLS + HTTP/3)"
  depends=('ca-certificates' 'brotli' 'libwolfssl' 'zlib' 'zstd' 'quiche')
  provides=('curl')
  conflicts=('curl' 'curl-rustls' 'curl-openssl')
  cd "curl-$pkgver/build-wolfssl"
  make DESTDIR="$pkgdir" install
}

# vim: ts=2 sw=2 et:
