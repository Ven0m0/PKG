pkgname=nvidia_oc
pkgver=0.1.21
pkgrel=1
makedepends=('rust' 'cargo')
arch=('x86_64' 'aarch64')
pkgdesc="A simple command line tool to overclock Nvidia GPUs using the NVML library on Linux. This supports both X11 and Wayland."
url='https://github.com/Dreaming-Codes/nvidia_oc'
license=('MIT')
# Generated in accordance to https://wiki.archlinux.org/title/Rust_package_guidelines.
# Might require further modification depending on the package involved.
prepare() {
  cargo fetch --locked --target "$CARCH-unknown-linux-gnu"
}

build() {
  export RUSTUP_TOOLCHAIN=stable CARGO_TARGET_DIR=target
  cargo build --frozen -r --all-features
}

check() {
  export RUSTUP_TOOLCHAIN=stable
  cargo test --frozen --all-features
}

package() {
  install -Dm0755 -t "$pkgdir/usr/bin/" "target/release/$pkgname"
  sudo cat > "/etc/systemd/system/nvidia_oc.service" <<'EOF'
  [Unit]
  Description=NVIDIA Overclocking Service
  After=network.target

  [Service]
  ExecStart=/usr/bin/nvidia_oc set --index 0 --power-limit 200000 --freq-offset 160 --mem-offset 750 --min-clock 0 --max-clock 2000
  User=root
  Group=root
  LimitNOFILE=65536
  Restart=on-failure

  [Install]
  WantedBy=multi-user.target
EOF
}
