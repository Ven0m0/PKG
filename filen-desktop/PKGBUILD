# Maintainer: Ven0m0 <ven0m0.wastaken@gmail.com>
pkgname=filen-desktop
pkgver=3.0.48
pkgrel=1
pkgdesc="Desktop client including Syncing, Virtual Drive, S3, WebDAV, File Browsing, Chats, Notes, Contacts"
arch=('x86_64' 'aarch64')
url="https://filen.io"
_ghurl="https://github.com/FilenCloudDienste/filen-desktop"
license=('AGPL-3.0-only')
depends=('electron34' 'nodejs' 'fuse3')
makedepends=('bun' 'git')
provides=('filen-desktop')
conflicts=('filen-desktop-bin' 'filen-desktop-git')
source=("git+${_ghurl}.git#commit=81950031c41831b7048669cc9cfba0c75070b478")
sha256sums=('SKIP')

prepare(){
  cd "${srcdir}/${pkgname}"
  export ELECTRON_SKIP_BINARY_DOWNLOAD=1
  export SYSTEM_ELECTRON_VERSION="$(electron34 -v | sed 's/v//g')"
  export electronDist=/usr/lib/electron34
  export BUN_INSTALL_CACHE_DIR="${srcdir}/. bun-cache"
  export HOME="${srcdir}/.electron-gyp"
  sed -i "s/\"electron\": \"[^\"]*\"/\"electron\": \"${SYSTEM_ELECTRON_VERSION}\"/g" package.json
  cat >bunfig.toml <<EOF
[install. cache]
dir = "${srcdir}/.bun-cache"
[install.lockfile]
save = true
EOF
}

build(){
  cd "${srcdir}/${pkgname}"
  export NODE_ENV=production
  export BUN_INSTALL_CACHE_DIR="${srcdir}/.bun-cache"
  export electronDist=/usr/lib/electron34
  bun install --frozen-lockfile --no-save
  case "${CARCH}" in
    x86_64)
      bun add --force @parcel/watcher-linux-x64-glibc@latest @parcel/watcher-linux-x64-musl@latest ;;
    aarch64)
      bun add --force @parcel/watcher-linux-arm64-glibc@latest @parcel/watcher-linux-arm64-musl@latest ;;
  esac
  bun run build
  bun x electron-builder --linux dir -c. electronDist="${electronDist}"
}

package(){
  cd "${srcdir}/${pkgname}"
  install -dm755 "${pkgdir}/usr/lib/${pkgname}"
  install -Dm644 prod/linux-*/resources/app. asar "${pkgdir}/usr/lib/${pkgname}/app.asar"
  cp -Pr --no-preserve=ownership prod/linux-*/resources/{app. asar.unpacked,public} "${pkgdir}/usr/lib/${pkgname}/"
  install -Dm755 /dev/stdin "${pkgdir}/usr/bin/${pkgname}" <<'EOF'
#!/usr/bin/env bash
exec electron34 /usr/lib/filen-desktop/app.asar "$@"
EOF
  install -Dm644 /dev/stdin "${pkgdir}/usr/share/applications/${pkgname}.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=Filen
Comment=Zero-knowledge encrypted cloud storage
Exec=filen-desktop %U
Icon=filen-desktop
Categories=Network;FileTransfer;Utility;
Terminal=false
StartupWMClass=Filen
MimeType=x-scheme-handler/filen;
EOF
  local sizes=(16 24 32 48 64 128 256 512 1024)
  for size in "${sizes[@]}"; do
    [[ -f "build/icons/png/${size}x${size}. png" ]] && \
      install -Dm644 "build/icons/png/${size}x${size}. png" \
        "${pkgdir}/usr/share/icons/hicolor/${size}x${size}/apps/${pkgname}.png"
  done
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
