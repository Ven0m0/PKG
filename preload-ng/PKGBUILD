#!/usr/bin/env bash
# Maintainer: Ven0m0
pkgname=preload-ng
pkgver=0.6.6
pkgrel=1
pkgdesc='Adaptive readahead daemon that prefetches files to reduce application startup times'
arch=('x86_64')
url='https://github.com/miguel-b-p/preload-ng'
license=('GPL-2.0-only')
depends=('glib2')
makedepends=('git')
optdepends=('ionice: reduce I/O priority' 'schedtool: adjust process scheduling')
backup=('etc/preload.conf')
source=("${pkgname}-${pkgver}.tar.gz::${url}/archive/refs/tags/${pkgver}.tar.gz")
sha256sums=('SKIP')

build(){
  cd "${pkgname}-${pkgver}/preload-src"
  make -j"$(nproc)" CFLAGS="${CFLAGS} -O3 -march=native -flto" LDFLAGS="${LDFLAGS} -flto"
}

package(){
  cd "${pkgname}-${pkgver}/preload-src"
  install -Dm755 preload "${pkgdir}/usr/bin/preload"
  install -Dm644 preload.conf "${pkgdir}/etc/preload.conf"
  install -Dm644 /dev/stdin "${pkgdir}/usr/lib/systemd/system/${pkgname}.service" <<'EOF'
[Unit]
Description=Preload-NG Adaptive Readahead Daemon
Documentation=https://github.com/miguel-b-p/preload-ng
After=local-fs.target
StartLimitIntervalSec=300
StartLimitBurst=5

[Service]
Type=simple
ExecStart=/usr/bin/preload --foreground --logfile ""
Restart=on-failure
RestartSec=10

# Security hardening
CapabilityBoundingSet=CAP_SYS_ADMIN CAP_IPC_LOCK CAP_SYS_PTRACE CAP_DAC_READ_SEARCH
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
NoNewPrivileges=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true
RestrictRealtime=true
RestrictNamespaces=true
LockPersonality=true
MemoryDenyWriteExecute=true
RestrictAddressFamilies=AF_UNIX AF_NETLINK
SystemCallFilter=@system-service
SystemCallErrorNumber=EPERM

# Resource limits
Nice=19
IOSchedulingClass=idle
StateDirectory=preload
ReadWritePaths=/var/lib/preload /var/log

[Install]
WantedBy=multi-user.target
EOF
  install -Dm644 /dev/stdin "${pkgdir}/usr/lib/sysusers.d/${pkgname}.conf" <<'EOF'
u preload - "Preload daemon" /var/lib/preload -
EOF
}
# vim: ts=2 sw=2 et:
