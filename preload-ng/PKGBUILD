# Maintainer: Your Name <youremail@example.com>
pkgname=preload-ng
pkgver=0.6.7
pkgrel=1
pkgdesc="An adaptive readahead daemon that prefetches files to reduce application startup times on Linux systems."
arch=('i686' 'x86_64' 'arm' 'aarch64')
url="https://github.com/miguel-b-p/preload-ng"
license=('GPL2')
depends=('glib2')
# Required build dependencies for the C code, Makefile, and config generation
makedepends=('git' 'base-devel' 'pkgconfig' 'sh')
# Fetch the source using the specific version tag
source=("${pkgname}::git+${url}.git#tag=v${pkgver}")
# Use SKIP since this is a VCS source
sha256sums=('SKIP')
# The directory where the source code (including the Makefile) is located
_srcdir="${srcdir}/${pkgname}/preload-src"

build() {
  cd "${_srcdir}"
  make
}

package() {
  cd "${_srcdir}"
  install -Dm755 "preload" "${pkgdir}/usr/sbin/preload"
  install -Dm644 "preload.conf" "${pkgdir}/etc/preload.conf"
  install -d "${pkgdir}/usr/lib/systemd/system"
  cat <<'EOF' >"${pkgdir}/usr/lib/systemd/system/preload-ng.service"
[Unit]
Description=Preload-NG Daemon - Adaptive Readahead
Documentation=https://github.com/miguel-b-p/preload-ng
After=local-fs.target network.target

[Service]
Type=simple
ExecStart=/usr/sbin/preload --foreground --logfile ""
ExecReload=/bin/kill -HUP \$MAINPID
Restart=on-failure
RestartSec=5
ProtectSystem=full
ProtectHome=true
PrivateTmp=true
NoNewPrivileges=true
# StateDirectory automatically creates /var/lib/preload and handles permissions.
StateDirectory=preload
# Allow write access to the standard log directory.
ReadWritePaths=/var/log

[Install]
WantedBy=multi-user.target
EOF
  install -d "${pkgdir}/var/lib/preload"
}
