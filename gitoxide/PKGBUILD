# Maintainer: Sebastian Thiel <sebastian.thiel@icloud.com>
pkgname=gitoxide
pkgver=0.46.0
pkgrel=1
makedepends=('rust' 'cargo')
arch=('x86_64' 'aarch64')
pkgdesc="A command-line application for interacting with git repositories"
license=('MIT OR Apache-2.0')
url='https://github.com/GitoxideLabs/gitoxide'
options=('strip')
source=("$pkgname-$pkgver.tar.gz::https://github.com/GitoxideLabs/$pkgname/archive/refs/tags/v$pkgver.tar.gz"
        "optimize.patch"
        "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.10.9.tar.xz")
sha256sums=('68a60cae90e0882cb3e1e699bc1c7e64902b632cc30209f60444c8ca8b2d820e' 'SKIP')

prepare() {
  cd "$pkgname-$pkgver"
  patch -p1 -i ../optimize.patch
  export RUSTUP_TOOLCHAIN=stable
  cargo fetch --locked --target "$(rustc --print host-tuple)"
}

build() {
  cd "$pkgname-$pkgver"
  CFLAGS+=' -ffat-lto-objects'
  # define PGO_PROFILE_DIR to use a custom directory for the profile data
  export MALLOC_CONF="thp:always,metadata_thp:always" RUSTUP_TOOLCHAIN=stable CARGO_TARGET_DIR=target \
    RUSTFLAGS="-C target-cpu=native -C opt-level=3 -C link-arg=-fuse-ld=lld" PGO_PROFILE_DIR=/tmp/pgo-data
  # clean up the profile data
  mkdir -p ${PGO_PROFILE_DIR}
  rm -f ${PGO_PROFILE_DIR}/*
  # append -Cprofile-generate=${PGO_PROFILE_DIR} to the rustflags
  export RUSTFLAGS+=" -Cprofile-generate=${PGO_PROFILE_DIR}"
  # First build
  cargo build -r --frozen --no-default-features --bins --lib --features max-pure
  # clean up the profile data
  rm -f ${PGO_PROFILE_DIR}/*
  # run the benchmark
  hyperfine --warmup 5 --min-runs 10 'target/release/gix -n "PM_RESUME" ../linux-6.10.9'
  hyperfine --warmup 5 --min-runs 10 'target/release/ein -n "PM_RESUME" ../linux-6.10.9'
  # run the tests
  cargo test
  # remove -Cprofile-generate=${PGO_PROFILE_DIR} from the rustflags
  export RUSTFLAGS="${RUSTFLAGS//-Cprofile-generate=${PGO_PROFILE_DIR}/}"
  # merge the profile data
  llvm-profdata merge -o ${PGO_PROFILE_DIR}/merged.profdata ${PGO_PROFILE_DIR}
  # append -Cprofile-use=${PGO_PROFILE_DIR} to the rustflags
  export RUSTFLAGS+=" -Cprofile-use=${PGO_PROFILE_DIR}/merged.profdata"
  # Second build with PGO
  cargo build -r --frozen --no-default-features --bins --lib --features max-pure
}

check() {
  cd "$pkgname-$pkgver"
  export RUSTUP_TOOLCHAIN=stable
  cargo test --locked --all-features -r
}

package() {
  cd "$pkgname-$pkgver"
  install -Dm0755 -t "$pkgdir/usr/bin/" "target/release/gix"
  install -Dm0755 -t "$pkgdir/usr/bin/" "target/release/ein"
}

# vim: ts=2 sw=2 et:
