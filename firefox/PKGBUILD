# Maintainer: Ven0m0
pkgname=firefox-custom
_pkgname=firefox
pkgver=133.0
pkgrel=1
pkgdesc='Firefox optimized'
arch=(x86_64)
url="https://mozilla.org/firefox"
license=(MPL-2.0)
provides=("firefox=${pkgver}")
conflicts=('firefox')
depends=('dbus-glib' 'gtk3' 'alsa-lib' 'nss' 'nspr' 'libstdc++' 'libxcomposite'
         'libxrandr' 'pango' 'dav1d' 'aom' 'icu' 'graphite' 'libwebp' 'libxt'
  alsa-lib
  at-spi2-core
  bash
  cairo
  dbus
  ffmpeg
  fontconfig
  freetype2
  gcc-libs
  gdk-pixbuf2
  glib2
  glibc
  gtk3
  hicolor-icon-theme
  libevent
  libjpeg
  libpulse
  libvpx
  libwebp
  libx11
  libxcb
  libxcomposite
  libxdamage
  libxext
  libxfixes
  libxrandr
  libxss
  libxt
  mime-types
  pango
  ttf-font
)
makedepends=('git' 'clang' 'lld' 'cmake' 'rust' 'cargo' 'ninja' 'python'
             'zip' 'unzip' 'autoconf2.13' 'clang-tools-extra' 'llvm'
             'bindgen' 'cargo-make' 'pkg-config' 'gtk-doc' 'sed' 'grep' 'file'
  git-cinnabar
  cbindgen
  clang
  diffutils
  imake
  jack
  lld
  llvm
  mesa
  nasm
  nodejs
  python
  rust
  unzip
  wasi-compiler-rt
  wasi-libc
  wasi-libc++
  wasi-libc++abi
  xorg-server-xvfb
  yasm
  zip             
)
optdepends=('hunspell-en_US: Spell checking, American English'
            'libnotify: Notification integration'
            'networkmanager: Location detection via available WiFi networks'
            'onnxruntime: Local machine learning features such as smart tab groups'
            'speech-dispatcher: Text-to-Speech'
            'xdg-desktop-portal: Screensharing with Wayland'
            'libdbusmenu-gtk3: global menu support'
            'profile-sync-daemon: Load the browser profile into RAM')
backup=()
options=(!strip !emptydirs !debug !makeflags !lto)
_repo=https://hg.mozilla.org/mozilla-unified
conflicts=('firefox')
provides=('firefox')
source=(
  "https://archive.mozilla.org/pub/firefox/releases/${pkgver}/source/firefox-${pkgver}.source.tar.xz"
  ${_pkgname}.desktop
  ${_pkgname}-symbolic.svg
  ${srcdir}/patches/0001-Install-under-remoting-name.patch
  ${srcdir}/patches/ffmpeg8-fix.patch
  ${srcdir}/patches/0001-enable-vaapi.patch
  ${srcdir}/patches/0002-remove-nvidia-blocklist.patch
  ${srcdir}/patches/0018-bmo-1516081-Disable-watchdog-during-PGO-builds.patch
  ${srcdir}/patches/17-feature-improved-send-progress.patch
  ${srcdir}/patches/1864247-fix-performance-in-FindHdr.patch
  ${srcdir}/patches/NNN9-reduce-console-noise-moz.patch
  ${srcdir}/patches/browser-modules-AsyncTabSwitcher.sys.patch
)
sha256sums=('SKIP')

# Tunables:
# : "${ENABLE_PGO:=1}"  -> run PGO (two-stage). You should run the instrumented build, exercise the browser to generate profiles, then rebuild.
# : "${ENABLE_BOLT:=1}" -> run llvm-bolt pass (requires llvm-bolt available in PATH)

: "${NATIVE_ARCH:=native}"
: "${ENABLE_POLLY:=1}" # -> enable polly compiler passes where feasible
# Build flags as arrays
_cflags=(-O3 -march=${NATIVE_ARCH} -mtune=${NATIVE_ARCH} -fomit-frame-pointer -ffunction-sections -fdata-sections -pipe -fno-plt -fno-semantic-interposition -fjump-tables)
_cppflags=("${_cflags[@]}")
_ldflags=(-Wl,-O3 -Wl,--gc-sections -Wl,--sort-common -Wl,--as-needed -Wl,-z,pack-relative-relocs -Wl,-z,relro -Wl,-z,now -flto -fuse-linker-plugin -Wl,-plugin-opt=emit-llvm)
_rustflags=(-Ctarget-cpu=native -Copt-level=3 -Clto=fat -Ccodegen-units=1 -Cpanic=abort -Cllvm-args=-enable-dfa-jump-thread -Clink-arg=-fuse-ld=lld -Zunstable-options -Ztune-cpu=native)

prepare() {
  cd "${srcdir}/${_pkgname}-${pkgver}" || :
  # Apply patches if any exist
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"; src="${src##*/}"
    [[ $src == *.patch ]] || continue
    echo "Applying patch ${src}..."
    patch -Np1 -i "${srcdir}/${src}" || :
  done
}

# Write a compact mozconfig to target minimal features
_write_mozconfig() {
  cat >.mozconfig <<'EOF'
ac_add_options --enable-application=browser
mk_add_options MOZ_OBJDIR=${PWD@Q}/obj
ac_add_options --prefix=/usr
ac_add_options --enable-optimize="-O3 -march=native"
ac_add_options OPT_LEVEL="3"
ac_add_options RUSTC_OPT_LEVEL="3"
ac_add_options --enable-rust-simd
ac_add_options --enable-wasm-simd
ac_add_options --enable-linker=lld
ac_add_options --with-ccache=sccache
ac_add_options --enable-lto=cross,full
ac_add_options MOZ_LTO=cross,full
ac_add_options MOZ_PGO=1
ac_add_options --enable-strip
ac_add_options --disable-install-strip
ac_add_options --enable-release
ac_add_options --enable-hardening
ac_add_options --disable-sandbox
ac_add_options --disable-tests
ac_add_options --disable-installer
ac_add_options --disable-maintenance-service
ac_add_options --disable-websockets
ac_add_options --disable-client-telemetry
ac_add_options --disable-crashreporter
ac_add_options --disable-health-report
ac_add_options --enable-default-toolkit=cairo-gtk3-wayland
ac_add_options --enable-wayland
ac_add_options --with-wasi-sysroot=/usr/share/wasi-sysroot
ac_add_options --with-unsigned-addon-scopes=app,system
ac_add_options --allow-addon-sideload
export CC='clang' CXX='clang++' AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib

# System libraries
ac_add_options --with-system-nspr
ac_add_options --with-system-nss
ac_add_options --with-system-libvpx
ac_add_options --with-system-webp
ac_add_options --with-system-libevent
ac_add_options --with-system-icu
ac_add_options --with-system-zlib
ac_add_options --with-system-jpeg

# Features
ac_add_options --enable-jxl
ac_add_options --enable-av1
ac_add_options --enable-pulseaudio
ac_add_options --enable-alsa
ac_add_options --disable-warnings-as-errors
ac_add_options --disable-crashreporter
ac_add_options --disable-tests
ac_add_options --disable-debug
ac_add_options --disable-updater
ac_add_options --disable-gpsd
ac_add_options --disable-synth-speechd
ac_add_options --disable-debug-symbols
ac_add_options --disable-debug-js-modules
ac_add_options --disable-rust-tests
ac_add_options --disable-rust-debug
ac_add_options --disable-necko-wifi
ac_add_options --disable-webspeech
ac_add_options --disable-webspeechtestbackend
ac_add_options --disable-phc
ac_add_options --disable-dmd
ac_add_options --disable-default-browser-agent
ac_add_options --without-wasm-sandboxed-libraries

# Disables crash reporting, telemetry and other data gathering tools
mk_add_options MOZ_CRASHREPORTER=0
mk_add_options MOZ_DATA_REPORTING=0
mk_add_options MOZ_SERVICES_HEALTHREPORT=0
mk_add_options MOZ_TELEMETRY_REPORTING=0
export MOZILLA_OFFICIAL=1 MOZ_NO_PIE_COMPAT=1 MOZ_NOSPAM=1 MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=pip MOZ_APP_REMOTINGNAME="$pkgname"
EOF
}

build() {
  cd "$srcdir"/${_pkgname}-${pkgver}

  # See https://github.com/glandium/git-cinnabar/issues/311
  git config remote.origin.mirror false
  
  _write_mozconfig

  # LTO needs more open files
  ulimit -n 4096

  # Environment
  export CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib LD=ld.lld LLVM_PROFDATA=llvm-profdata
  export PYTHONOPTIMIZE=2 RUSTC_WRAPPER=sccache CARGO_CACHE_RUSTC_INFO=1
  export MOZ_NOSPAM=1 MOZ_ENABLE_WAYLAND=1 MOZ_DBUS_REMOTE=1 MOZ_ENABLE_XINPUT2=1 MOZ_DISABLE_RDD_SANDBOX=1 \
    MOZ_CRASHREPORTER=0 MOZ_DATA_REPORTING=0 MOZ_SERVICES_HEALTHREPORT=0 MOZ_TELEMETRY_REPORTING=0 \
    MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=pip MOZ_LTO=cross,full MOZ_BUILD_DATE="$(date -u${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH} +%Y%m%d%H%M%S)"
  # Work around https://bugzilla.mozilla.org/show_bug.cgi?id=1969383
  export RUST_MIN_STACK=16777216
  
  export LIBGL_ALWAYS_SOFTWARE=true
  export CFLAGS="${_cflags[*]} ${CFLAGS:-}"
  export CXXFLAGS="${_cppflags[*]} ${CXXFLAGS:-}"
  export LDFLAGS="${_ldflags[*]} ${LDFLAGS:-}"
  export RUSTFLAGS="${_rustflags[*]} ${RUSTFLAGS:-}"
  export OPT_LEVEL=3 CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1
  export CFLAGS="${CFLAGS/-fexceptions/}"
  export CXXFLAGS="${CXXFLAGS/-fexceptions/}"
  export CFLAGS="${CFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2}"
  export CXXFLAGS="${CXXFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2}"
  # Polly/Propeller opt-in
  if [[ -n "${ENABLE_POLLY:-}" ]]; then
    export CFLAGS+=" -mllvm -polly -mllvm -polly-vectorizer=stripmine"
    export CXXFLAGS+=" -mllvm -polly -mllvm -polly-vectorizer=stripmine"
  fi

  # PGO instrumentation build
  if [[ -n "${ENABLE_PGO:-}" ]]; then
    export CFLAGS+=" -fprofile-generate=profile_data"
    export CXXFLAGS+=" -fprofile-generate=profile_data"
    export RUSTFLAGS+=" -C profile-generate=profile_data"
    echo "PGO: instrumented build. After this completes, run the browser to generate profiles, then rebuild with ENABLE_PGO=use"
  fi

  # Configure / build via mach
  ./mach bootstrap --no-interactive --application-choice=browser || true
  ./mach build --priority normal -j$(nproc) || return 1

  # If running BOLT rewriting is requested and llvm-bolt exists, run on the main binaries
  if [[ -n "${ENABLE_BOLT:-}" ]] && command -v llvm-bolt >/dev/null 2>&1; then
    # Collect target binaries
    objdir=./obj-firefox/dist
    for bin in "$objdir"/firefox "$objdir"/libxul.so; do
      [[ -f "$bin" ]] || continue
      # Placeholder profile path; user should generate profile_data.prof by running instrumented binary
      prof=profile_data/merged.prof
      if [[ -f "$prof" ]]; then
        llvm-bolt "$bin" -o "${bin}.bolt" --data="$prof" || true
        mv -f "${bin}.bolt" "$bin" || true
      fi
    done
  fi

  # If PGO use-phase requested
  if [[ "${ENABLE_PGO:-}" == "use" ]]; then
    export CFLAGS="${_cflags[*]} -fprofile-use=profile_data -fprofile-correction"
    export CXXFLAGS="${_cppflags[*]} -fprofile-use=profile_data -fprofile-correction"
    export RUSTFLAGS="${_rustflags[*]} -C profile-use=profile_data"
    ./mach clobber || true
    ./mach build || return 1
  fi
}

package() {
  cd "${srcdir}/${_pkgname}-${pkgver}"
  objdir=./obj-firefox/dist
  DESTDIR="$pkgdir" ./mach install
  _vendorjs="${pkgdir}/usr/lib/${_pkgname}/browser/defaults/preferences/vendor.js"
  install -Dm644 /dev/stdin "$_vendorjs" <<END
pref("intl.locale.requested", "");
pref("spellchecker.dictionary_path", "/usr/share/hunspell");
pref("browser.shell.checkDefaultBrowser", false);
pref("image.jxl.enabled", true);
pref("extensions.autoDisableScopes", 11);
pref("extensions.shownSelectionUI", true);
pref("browser.aboutConfig.showWarning", false);
pref("datareporting.healthreport.uploadEnabled", false);
pref("datareporting.policy.dataSubmissionEnabled", false);
pref("toolkit.telemetry.enabled", false);
pref("toolkit.telemetry.unified", false);
pref("services.settings.main.search-telemetry-v2.last_check", $(date +%s));
pref("browser.ping-centre.telemetry", false);
pref("app.normandy.enabled", false);
pref("app.shield.optoutstudies.enabled", false);
pref("extensions.getAddons.showPane", false);
pref("extensions.htmlaboutaddons.recommendations.enabled", false);
pref("browser.discovery.enabled", false);
END

  _distini="${pkgdir}/usr/lib/${_pkgname}/distribution/distribution.ini"
  install -Dm644 /dev/stdin "$_distini" <<END
[Global]
id=archlinux
version=1.0
about=Mozilla Firefox for Arch Linux

[Preferences]
app.distributor=archlinux
app.distributor.channel=$_pkgname
app.partner.archlinux=archlinux
END
  install -Dm755 "${objdir}/firefox" "${pkgdir}/usr/bin/firefox-custom"
  mkdir -p "${pkgdir}/usr/lib/firefox-custom"
  cp -a "${objdir}/"* "${pkgdir}/usr/lib/firefox-custom/"

  # Minimal desktop file
  install -Dm644 /dev/stdin "${pkgdir}/usr/share/applications/firefox-custom.desktop" <<'DESK'
[Desktop Entry]
Name=Firefox Custom
Exec=/usr/bin/firefox-custom %u
Terminal=false
Type=Application
Categories=Network;WebBrowser;
DESK
  # Icons if present
  if [[ -d "${objdir}/browser/branding/distribution/icons" ]]; then
    mkdir -p "${pkgdir}/usr/share/icons/hicolor/128x128/apps"
    cp -a "${objdir}/browser/branding/distribution/icons/"* \
      "${pkgdir}/usr/share/icons/hicolor/128x128/apps/" 2>/dev/null || true
  fi
  for i in 16 22 24 32 48 64 128 256; do
    install -Dm644 browser/branding/official/default$i.png \
      "${pkgdir}/usr/share/icons/hicolor/${i}x${i}/apps/${_pkgname}.png"
  done
  install -Dm644 browser/branding/official/content/about-logo.png \
    "${pkgdir}/usr/share/icons/hicolor/192x192/apps/${_pkgname}.png"
  install -Dm644 browser/branding/official/content/about-logo@2x.png \
    "${pkgdir}/usr/share/icons/hicolor/384x384/apps/${_pkgname}.png"
  install -Dm644 ../firefox-symbolic.svg \
    "${pkgdir}/usr/share/icons/hicolor/symbolic/apps/${_pkgname}-symbolic.svg"

  install -Dm644 ../${_pkgname}.desktop \
    "${pkgdir}/usr/share/applications/${_pkgname}.desktop"
  # Install a wrapper to avoid confusion about binary path
  install -Dm755 /dev/stdin "${pkgdir}/usr/bin/${_pkgname}" <<END
#!/bin/sh
exec /usr/lib/$_pkgname/firefox "\$@"
END
  # Replace duplicate binary with wrapper
  # https://bugzilla.mozilla.org/show_bug.cgi?id=658850
  ln -srf "${pkgdir}/usr/bin/${_pkgname}" \
    "${pkgdir}/usr/lib/${_pkgname}/firefox-bin"
}

# vim: ts=2 sw=2 et:
