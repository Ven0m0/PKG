# Maintainer: Ven0m0
# Merged from multiple optimized Firefox PKGBUILDs
# Features: Aggressive optimization, PGO, VA-API, system libraries, hardware acceleration
pkgname=firefox-custom
_pkgname=firefox
pkgver=148.0
pkgrel=1
pkgdesc='Firefox with aggressive optimizations, VA-API, PGO, and all performance tweaks'
arch=(x86_64)
url="https://mozilla.org/firefox"
license=(MPL-2.0)
provides=("firefox=${pkgver}")
conflicts=('firefox')
depends=(
  alsa-lib at-spi2-core bash cairo dbus ffmpeg4.4 fontconfig freetype2
  gcc-libs gdk-pixbuf2 glib2 glibc gtk3 hicolor-icon-theme libevent
  libjpeg libpulse libvpx libwebp mime-types nss nspr pango
  ttf-font dbus-glib dav1d aom icu graphite harfbuzz
)
makedepends=(
  autoconf2.13 bindgen cargo cargo-make cbindgen clang clang-tools-extra
  cmake diffutils git git-cinnabar gtk-doc imake jack lld llvm mesa nasm
  ninja nodejs pkg-config python rust sed grep file unzip dump_syms
  wasi-compiler-rt wasi-libc wasi-libc++ wasi-libc++abi
  yasm zip mercurial tinywl
)
optdepends=(
  'hunspell-en_US:  Spell checking, American English'
  'libnotify: Notification integration'
  'networkmanager: Location detection via available WiFi networks'
  'onnxruntime:  Local machine learning features'
  'speech-dispatcher: Text-to-Speech'
  'xdg-desktop-portal: Screensharing with Wayland'
  'libdbusmenu-gtk3: Global menu support'
  'profile-sync-daemon: Load browser profile into RAM'
  'kmozillahelper: KDE integration'
)
options=(!strip !emptydirs !debug !makeflags !lto)
source=(
  "https://archive.mozilla.org/pub/firefox/releases/${pkgver}/source/firefox-${pkgver}.source.tar.xz"
  ${_pkgname}.desktop
  ${_pkgname}-symbolic.svg
  patches/*.patch
  patches/ghostery/*.patch
  patches/firedragon/*.patch
)
sha256sums=('08d4cae010abc31603ef74091a5d1f81da8e62d3b66c806690e70f03c422df16' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')
# Tunables - set these in your environment to control build behavior
:  "${NATIVE_ARCH:=native}"      # CPU architecture to optimize for
: "${ENABLE_PGO:=true}"         # Profile-Guided Optimization (recommended)
: "${ENABLE_PGO_REUSE:=true}"   # Reuse previous PGO profiles
: "${ENABLE_PGO_3STAGE:=false}" # 3-stage context-sensitive PGO (higher performance, 50% longer build)
: "${ENABLE_BOLT:=false}"       # LLVM BOLT optimization (requires llvm-bolt)
: "${ENABLE_POLLY:=true}"       # Polly loop optimization
: "${ENABLE_VAAPI:=true}"       # Hardware video acceleration
: "${BUILD_LIMIT_CORES:=true}"  # Auto-limit cores based on available RAM
: ${_build_lto:=true}
: ${_build_system_libs:=true}
# Aggressive optimization flags
_cflags=(
  -O3
  -march=${NATIVE_ARCH} -mtune=${NATIVE_ARCH}
  -fomit-frame-pointer
  -ffunction-sections -fdata-sections
  -pipe -fjump-tables
  -fno-plt -fno-semantic-interposition
)
_cppflags=("${_cflags[@]}")
_ldflags=(
  -fuse-ld=lld -flto=auto
  -Wl,-O3 -Wl,--gc-sections
  -Wl,--sort-common -Wl,--as-needed
  -Wl,-z,pack-relative-relocs -Wl,--hash-style=gnu
  -Wl,-z,relro -Wl,-z,now -Wl,--icf=safe
)
_rustflags=(
  -Ctarget-cpu=native -Copt-level=3
  -Ccodegen-units=1 -Clto=fat -Cpanic=abort
  -Clink-arg=-z -Clink-arg=pack-relative-relocs -Clink-arg=-fuse-ld=lld
  -Cdebuginfo=0 -Cforce-frame-pointers=no -Cllvm-args=-enable-dfa-jump-thread
)
# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# Note: These are for Arch Linux use ONLY. For your own distribution, please
# get your own set of keys.  Feel free to contact foutrelis@archlinux.org for
# more information.
_google_api_key=AIzaSyDwr302FpOSkGRpLlUpPThNTDPbXcIn_FM
# Mozilla API keys (see https://location.services.mozilla.com/api)
# Note: These are for Arch Linux use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact heftig@archlinux.org for
# more information.
_mozilla_api_key=16674381-f021-49de-8622-3021c5942aff

prepare(){
  mkdir -p mozbuild
  cd "$_pkgname-$pkgver"
  # EVENT__SIZEOF_TIME_T does not exist on upstream libevent, see event-config.h. cmake
  sed -i '/CHECK_EVENT_SIZEOF(TIME_T, time_t);/d' ipc/chromium/src/base/message_pump_libevent.cc
  echo -n "$_google_api_key" >google-api-key
  echo -n "$_mozilla_api_key" >mozilla-api-key
  # Apply any patches
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src == *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 -i "../${src}" || exit 1
  done
  # Clear forced startup pages
  sed -E -e 's&^\s*pref\("startup\.homepage.*$&&' -i browser/branding/*/pref/firefox-branding.js
}
_write_mozconfig(){
  cd "$srcdir/$_pkgname-$pkgver"
  # Calculate optimal core count based on available RAM
  local _cores _mem _nproc
  _mem=$(grep -Pom1 '^MemAvailable.*\b\K[0-9]+' /proc/meminfo)
  _nproc=$(nproc)
  if [[ ${BUILD_LIMIT_CORES} == "true" ]]; then
    # Firefox needs ~3GB per core for linking, use available memory
    _cores=$((_mem / (3 * 1024 * 1024)))
    _cores=$((_cores < 1 ? 1 : _cores))
    _cores=$((_cores > _nproc ? _nproc : _cores))
    echo "Available RAM: $((_mem / (1024 * 1024)))GB, Using $_cores cores (of $_nproc available)"
  else
    _cores="$_nproc"
    echo "Using all $_cores cores"
  fi

  cat >../mozconfig <<END
# Build paths
mk_add_options MOZ_OBJDIR=${PWD@Q}/obj
mk_add_options AUTOCLOBBER=1
ac_add_options --prefix=/usr
ac_add_options --with-wasi-sysroot=/usr/share/wasi-sysroot

# Application
ac_add_options --enable-application=browser
ac_add_options --enable-release

# Build source info
export MOZ_INCLUDE_SOURCE_INFO=1

# Compiler toolchain
export AR=llvm-ar
export CC=clang
export CXX=clang++
export NM=llvm-nm
export RANLIB=llvm-ranlib
ac_add_options --enable-linker=lld
ac_add_options --enable-clang-plugin
ac_add_options --disable-cargo-incremental
# Optimization
ac_add_options --enable-optimize="-O3 -w -march=native -mtune=native -ftree-vectorize"
export RUSTC_OPT_LEVEL=3
export OPT_LEVEL=3
export CARGO_PROFILE_RELEASE_OPT_LEVEL=3
ac_add_options OPT_LEVEL="3"
ac_add_options RUSTC_OPT_LEVEL="3"
ac_add_options --enable-hardening
ac_add_options --disable-bootstrap
ac_add_options --disable-elf-hack

# LTO
ac_add_options --enable-lto=cross,full

# Stripping and minification
ac_add_options --enable-strip
ac_add_options --enable-install-strip
ac_add_options --enable-minify=properties

# Memory allocator
ac_add_options --enable-jemalloc
ac_add_options --enable-replace-malloc

# Parallelism
mk_add_options MOZ_PARALLEL_COMPILE=${_cores}
mk_add_options MOZ_PARALLEL_BUILD=${_cores}

# System libraries
ac_add_options --with-system-nspr
ac_add_options --with-system-nss
ac_add_options --with-system-libvpx
ac_add_options --with-system-webp
ac_add_options --with-system-libevent
ac_add_options --with-system-icu
ac_add_options --with-system-zlib
ac_add_options --with-system-jpeg
ac_add_options --enable-system-cairo
ac_add_options --enable-shared-js
# ac_add_options --with-system-png
# ac_add_options --without-wasm-sandboxed-libraries

# WebRTC
ac_add_options --enable-webrtc

# Image formats
ac_add_options --enable-jxl
ac_add_options --enable-av1
ac_add_options --enable-raw

# Wayland
ac_add_options --enable-wayland
ac_add_options --enable-default-toolkit=cairo-gtk3-wayland-only

# WASM optimizations
ac_add_options --enable-wasm-avx
ac_add_options --enable-rust-simd
ac_add_options --enable-wasm-simd
ac_add_options --enable-wasm-relaxed-simd
ac_add_options --enable-wasm-memory64
ac_add_options --enable-wasm-memory-control
ac_add_options --enable-wasm-multi-memory
ac_add_options --enable-wasm-branch-hinting

# Audio backends
ac_add_options --enable-pulseaudio
ac_add_options --enable-alsa
ac_add_options --disable-jack

# DRM
ac_add_options --enable-eme=widevine

# Network
ac_add_options --enable-proxy-bypass-protection

# Updates and sideloading
ac_add_options --enable-update-channel=release
ac_add_options --enable-unverified-updates
ac_add_options --allow-addon-sideload
ac_add_options --with-unsigned-addon-scopes=app,system

# Sandbox
ac_add_options --enable-sandbox

# Disabled features
ac_add_options --disable-artifact-builds
ac_add_options --disable-debug
ac_add_options --disable-debug-symbols
ac_add_options --disable-debug-js-modules
ac_add_options --disable-tests
ac_add_options --disable-parental-controls
ac_add_options --disable-crashreporter
ac_add_options --disable-updater
ac_add_options --disable-necko-wifi
ac_add_options --disable-installer
ac_add_options --disable-maintenance-service
ac_add_options --disable-websockets
ac_add_options --disable-gpsd
ac_add_options --disable-synth-speechd
ac_add_options --disable-rust-tests
ac_add_options --disable-webspeech
ac_add_options --disable-webspeechtestbackend
ac_add_options --disable-default-browser-agent
ac_add_options --disable-warnings-as-errors
ac_add_options --disable-valgrind
ac_add_options --disable-dmd
ac_add_options --disable-phc
ac_add_options --disable-bits-download
ac_add_options --disable-legacy-profile-creation
ac_add_options --disable-accessibility
ac_add_options --disable-wmf
ac_add_options --disable-gecko-profiler
ac_add_options --disable-real-time-tracing
ac_add_options --disable-webdriver
ac_add_options --disable-negotiateauth

# Branding
ac_add_options --enable-official-branding
ac_add_options --with-distribution-id=org.archlinux
export MOZILLA_OFFICIAL=1
export MOZ_APP_REMOTINGNAME=${pkgname//-/}
export MOZ_REQUIRE_SIGNING=0

# Telemetry, reporting, crash (disabled)
export MOZ_TELEMETRY_REPORTING=0
export MOZ_CRASHREPORTER=0
export MOZ_DATA_REPORTING=0
mk_add_options MOZ_CRASHREPORTER=0
mk_add_options MOZ_DATA_REPORTING=0
mk_add_options MOZ_SERVICES_HEALTHREPORT=0
mk_add_options MOZ_TELEMETRY_REPORTING=0
mk_add_options MOZ_NORMANDY=0
ac_add_options --disable-client-telemetry
ac_add_options --disable-health-report

# JS Shell (for PGO)
ac_add_options --enable-js-shell
export MOZ_PACKAGE_JSSHELL=1

# Build environment
export MOZ_NO_PIE_COMPAT=1
export MOZ_NOSPAM=1
export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=system
export PYTHONOPTIMIZE=2
export MOZ_DEBUG_FLAGS=""

# Compiler flags (additional)
export CFLAGS+=" -g0"
export CXXFLAGS+=" -g0"
export LDFLAGS+=" -Wl,--no-keep-memory"
export RUSTFLAGS="-Cdebuginfo=0 -Ctarget-cpu=native -Copt-level=3"

# API keys
ac_add_options --with-google-location-service-api-keyfile=${PWD@Q}/google-api-key
ac_add_options --with-google-safebrowsing-api-keyfile=${PWD@Q}/google-api-key
ac_add_options --with-mozilla-api-keyfile=${PWD@Q}/mozilla-api-key
END
  # See https://github.com/glandium/git-cinnabar/issues/311
  git config remote.origin.mirror false
  # Optional: use sccache if available
  command -v sccache &>/dev/null && echo 'ac_add_options --with-ccache=sccache' >>../mozconfig
}

build(){
  # Unset variables to prevent issues with PGO profiling
  unset DBUS_SESSION_BUS_ADDRESS \
    DISPLAY \
    ORBIT_SOCKETDIR \
    SESSION_MANAGER \
    XAUTHORITY \
    XDG_CACHE_HOME \
    XDG_SESSION_COOKIE
  local VIRTWL VIRTWL_PID
  cd "$_pkgname-$pkgver"
  # Check for required commands
  local _missing_cmds=()
  for cmd in clang clang++ lld llvm-ar llvm-nm llvm-ranlib xvfb-run dbus-run-session; do
    command -v "$cmd" &>/dev/null || _missing_cmds+=("$cmd")
  done
  if [[ ${#_missing_cmds[@]} -gt 0 ]]; then
    echo "ERROR: Missing required commands: ${_missing_cmds[*]}"
    return 1
  fi
  # Write optimized mozconfig
  _write_mozconfig
  # Environment setup
  ulimit -n 4096
  # Build date
  export MOZ_BUILD_DATE="$(date -u${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH} +%Y%m%d%H%M%S)"
  export CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib LD=ld. lld RUST_MIN_STACK=16777216 PYTHONOPTIMIZE=2 CARGO_CACHE_RUSTC_INFO=1 OPT_LEVEL=3 CARGO_INCREMENTAL=0 MOZ_NOSPAM=1 MOZ_ENABLE_FULL_SYMBOLS=0
  # Use sccache if available
  command -v sccache &>/dev/null && export RUSTC_WRAPPER=sccache
  # Apply optimization flags
  CFLAGS="${_cflags[*]} ${CFLAGS:-}"
  CXXFLAGS="${_cflags[*]} ${CXXFLAGS:-}"
  # malloc_usable_size compatibility
  CFLAGS="${CFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2}"
  CXXFLAGS="${CXXFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2}"
  # Remove -fexceptions (breaks compilation)
  CFLAGS="${CFLAGS/-fexceptions/}"
  CXXFLAGS="${CXXFLAGS/-fexceptions/}"
  LDFLAGS="${_ldflags[*]} ${LDFLAGS:-}"
  RUSTFLAGS="${_rustflags[*]} ${RUSTFLAGS:-}"
  # Polly optimization
  if [[ ${ENABLE_POLLY} == "true" ]]; then
    echo "Enabling Polly loop optimization..."
    CFLAGS+=" -mllvm -polly -mllvm -polly-vectorizer=stripmine"
    CXXFLAGS+=" -mllvm -polly -mllvm -polly-vectorizer=stripmine"
  fi
  export CFLAGS CXXFLAGS LDFLAGS RUSTFLAGS
  # Profile-Guided Optimization
  # Use SRCDEST if set, otherwise use a cache directory
  local _pgo_cache="${SRCDEST:-$srcdir/. pgo-cache}"
  mkdir -p "$_pgo_cache"
  local _pgo_profdata="$_pgo_cache/firefox-$pkgver-merged.profdata"
  local _pgo_profdata_cs="$_pgo_cache/firefox-$pkgver-merged-cs.profdata"
  local _pgo_jarlog="$_pgo_cache/firefox-$pkgver-jarlog"
  # Export XDG_RUNTIME_DIR for tinywl
  export XDG_RUNTIME_DIR="/tmp/$(id -u)-runtime-dir"
  mkdir -pm 0700 "$XDG_RUNTIME_DIR"
  # Run tinywl compositor for PGO profiling
  coproc VIRTWL {
    WLR_RENDERER=pixman WLR_BACKENDS=headless \
      exec dbus-run-session -- tinywl -s 'echo $WAYLAND_DISPLAY; read _; kill $PPID'
  }
  local -x WAYLAND_DISPLAY
  read WAYLAND_DISPLAY <&${VIRTWL[0]}
  if [[ ${ENABLE_PGO} == "true" ]]; then
    # Determine which profile to use
    local _final_profile="merged. profdata"
    if [[ ${ENABLE_PGO_3STAGE} == "true" ]]; then
      _final_profile="merged-cs.profdata"
      echo "3-stage context-sensitive PGO enabled"
    fi
    # Try to reuse existing profile
    if [[ ${ENABLE_PGO_REUSE} == "true" ]]; then
      if [[ ${ENABLE_PGO_3STAGE} == "true" ]] && [[ -s $_pgo_profdata_cs ]]; then
        echo "Reusing existing 3-stage PGO profile data..."
        cp "$_pgo_profdata_cs" merged-cs.profdata
        cp "$_pgo_profdata" merged. profdata 2>/dev/null || true
        [[ -s $_pgo_jarlog ]] && cp "$_pgo_jarlog" jarlog
      elif [[ ${ENABLE_PGO_3STAGE} == "false" ]] && [[ -s $_pgo_profdata ]]; then
        echo "Reusing existing 2-stage PGO profile data..."
        cp "$_pgo_profdata" merged.profdata
        [[ -s $_pgo_jarlog ]] && cp "$_pgo_jarlog" jarlog
      fi
    fi
    # Stage 1: Generate initial profile if needed
    if [[ !  -s merged.profdata ]]; then
      echo "==> PGO Stage 1: Building instrumented browser..."
      cat >. mozconfig ../mozconfig - <<END
ac_add_options --enable-profile-generate=cross
export MOZ_ENABLE_FULL_SYMBOLS=1
END
      ./mach build --priority normal
      echo "==> PGO Stage 1: Profiling instrumented browser..."
      ./mach package
      LLVM_PROFDATA=llvm-profdata JARLOG_FILE="$PWD/jarlog" \
        LIBGL_ALWAYS_SOFTWARE=true ./mach python build/pgo/profileserver.py
      if [[ -s merged. profdata ]]; then
        stat -c "Stage 1 profile generated (%s bytes)" merged.profdata
        cp merged.profdata "$_pgo_profdata"
        [[ -s jarlog ]] && cp jarlog "$_pgo_jarlog"
        echo "==> Cleaning Stage 1 build..."
        ./mach clobber objdir
      else
        echo "WARNING: PGO Stage 1 failed, continuing without PGO"
        ENABLE_PGO=false
      fi
    fi
    # Stage 2: Context-sensitive profiling (only if 3-stage is enabled)
    if [[ ${ENABLE_PGO} == "true" ]] && [[ ${ENABLE_PGO_3STAGE} == "true" ]] && [[ !  -s merged-cs.profdata ]]; then
      echo "==> PGO Stage 2: Building with Stage 1 profile for context-sensitive profiling..."
      cat >.mozconfig ../mozconfig - <<END
ac_add_options --enable-profile-generate=cross
ac_add_options --enable-profile-use=cross
ac_add_options --with-pgo-profile-path=${PWD@Q}/merged.profdata
export MOZ_ENABLE_FULL_SYMBOLS=1
END
      if [[ -s jarlog ]]; then
        echo "ac_add_options --with-pgo-jarlog=${PWD@Q}/jarlog" >>.mozconfig
      fi
      ./mach build --priority normal
      echo "==> PGO Stage 2: Profiling context-sensitive build..."
      ./mach package
      LLVM_PROFDATA=llvm-profdata \
        LIBGL_ALWAYS_SOFTWARE=true \
        ./mach python build/pgo/profileserver.py
      # Merge Stage 1 and Stage 2 profiles
      if ls *.profraw &>/dev/null; then
        echo "==> Merging Stage 1 and Stage 2 profiles into context-sensitive profile..."
        llvm-profdata merge --sparse=true merged.profdata *.profraw -o merged-cs.profdata
        if [[ -s merged-cs.profdata ]]; then
          stat -c "Context-sensitive profile generated (%s bytes)" merged-cs.profdata
          cp merged-cs.profdata "$_pgo_profdata_cs"
          echo "==> Cleaning Stage 2 build..."
          ./mach clobber objdir
        else
          echo "WARNING: Context-sensitive profile merge failed, falling back to 2-stage PGO"
          ENABLE_PGO_3STAGE=false
          _final_profile="merged.profdata"
        fi
      else
        echo "WARNING: No Stage 2 profraw files found, falling back to 2-stage PGO"
        ENABLE_PGO_3STAGE=false
        _final_profile="merged.profdata"
      fi
    fi
    # Final build with PGO profile
    if [[ ${ENABLE_PGO} == "true" ]] && [[ -s $_final_profile ]]; then
      if [[ ${ENABLE_PGO_3STAGE} == "true" ]]; then
        echo "==> PGO Stage 3: Building final optimized browser with context-sensitive profile..."
      else
        echo "==> Building final optimized browser with PGO..."
      fi
      cat >. mozconfig ../mozconfig - <<END
ac_add_options --enable-lto=cross,full
ac_add_options --enable-profile-use=cross
ac_add_options --with-pgo-profile-path=${PWD@Q}/$_final_profile
END
      if [[ -s jarlog ]]; then
        echo "ac_add_options --with-pgo-jarlog=${PWD@Q}/jarlog" >>.mozconfig
      fi
    else
      # Build without PGO
      echo "Building without PGO..."
      cat >.mozconfig ../mozconfig
    fi
  else
    # PGO disabled by user
    echo "Building without PGO (disabled)..."
    cat >.mozconfig ../mozconfig
  fi
  # Main build
  ./mach build --priority normal
  # BOLT optimization (optional, requires llvm-bolt)
  if [[ ${ENABLE_BOLT} == "true" ]] && command -v llvm-bolt &>/dev/null; then
    echo "Applying BOLT optimizations..."
    local objdir=./obj/dist
    for bin in "$objdir"/firefox "$objdir"/libxul. so; do
      [[ -f $bin ]] || continue
      local prof="${PWD}/merged.profdata"
      if [[ -f $prof ]]; then
        llvm-bolt "$bin" -o "${bin}. bolt" --data="$prof" \
          -reorder-blocks=ext-tsp \
          -reorder-functions=hfsort \
          -split-functions=3 \
          -split-all-cold \
          -dyno-stats \
          -icf=1 || : 
        [[ -f "${bin}.bolt" ]] && mv -f "${bin}.bolt" "$bin"
      fi
    done
  fi
  exec {VIRTWL[0]}<&- {VIRTWL[1]}>&-
  rm -rf "${XDG_RUNTIME_DIR}"
}
package(){
  cd "$_pkgname-$pkgver"
  DESTDIR="$pkgdir" ./mach install
  # Vendor preferences (privacy, performance, hardware acceleration)
  install -Dm644 /dev/stdin "$pkgdir/usr/lib/$_pkgname/browser/defaults/preferences/vendor.js" <<END
// Use LANG environment variable
pref("intl.locale.requested", "");
// System dictionaries
pref("spellchecker.dictionary_path", "/usr/share/hunspell");
// Don't check for default browser
pref("browser.shell.checkDefaultBrowser", false);
// Enable JXL images
pref("image.jxl.enabled", true);
// Allow unsigned extensions
pref("extensions.autoDisableScopes", 11);
pref("extensions.shownSelectionUI", true);
// Disable about:config warning
pref("browser.aboutConfig.showWarning", false);
// Disable telemetry
pref("datareporting.healthreport.uploadEnabled", false);
pref("datareporting.policy.dataSubmissionEnabled", false);
pref("toolkit.telemetry.enabled", false);
pref("toolkit.telemetry.unified", false);
pref("toolkit.telemetry.archive.enabled", false);
pref("browser.ping-centre.telemetry", false);
// Disable experiments
pref("app.normandy.enabled", false);
pref("app.shield.optoutstudies.enabled", false);
// Disable recommendations
pref("extensions.getAddons.showPane", false);
pref("extensions.htmlaboutaddons.recommendations.enabled", false);
pref("browser.discovery.enabled", false);
// GNOME integration
pref("browser.gnome-search-provider.enabled", true);
// XDG portals
pref("widget.use-xdg-desktop-portal. file-picker", 1);
pref("widget.use-xdg-desktop-portal.mime-handler", 1);
// Prevent telemetry notification
pref("services.settings.main.search-telemetry-v2.last_check", $(date +%s));
// Hardware acceleration (VA-API)
pref("gfx.webrender.all", true);
pref("media.hardware-video-decoding. enabled", true);
pref("media.hardware-video-decoding.force-enabled", true);
pref("media.ffmpeg.vaapi.enabled", true);
pref("media.rdd-ffmpeg.enabled", true);
pref("media.av1.enabled", true);
pref("media.webrtc.hw. h264.enabled", true);
// Performance tweaks
pref("layers.acceleration.force-enabled", true);
pref("webgl.force-enabled", true);
pref("dom.ipc.processCount", 8);
pref("browser.tabs.remote.autostart", true);
END
  # Distribution info
  install -Dm644 /dev/stdin "$pkgdir/usr/lib/$_pkgname/distribution/distribution.ini" <<END
[Global]
id=archlinux
version=1.0
about=Firefox custom build for Arch Linux with optimizations
[Preferences]
app.distributor=archlinux
app.distributor. channel=$_pkgname
app.partner.archlinux=archlinux
END
  # GNOME search provider
  install -Dm644 /dev/stdin "$pkgdir/usr/share/gnome-shell/search-providers/$_pkgname.search-provider. ini" <<END
[Shell Search Provider]
DesktopId=$_pkgname. desktop
BusName=org.mozilla.${_pkgname//-/}. SearchProvider
ObjectPath=/org/mozilla/${_pkgname//-/}/SearchProvider
Version=2
END
  # Icons
  for i in 16 22 24 32 48 64 128 256; do
    install -Dm644 browser/branding/official/default$i.png \
      "$pkgdir/usr/share/icons/hicolor/${i}x${i}/apps/$_pkgname.png"
  done
  install -Dm644 browser/branding/official/content/about-logo.png \
    "$pkgdir/usr/share/icons/hicolor/192x192/apps/$_pkgname.png"
  install -Dm644 browser/branding/official/content/about-logo@2x.png \
    "$pkgdir/usr/share/icons/hicolor/384x384/apps/$_pkgname.png"
  install -Dm644 .. /$_pkgname-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/$_pkgname-symbolic.svg"
  # Desktop file
  install -Dm644 .. /"$_pkgname". desktop \
    "$pkgdir/usr/share/applications/$_pkgname.desktop"
  # Wrapper script
  install -Dm755 /dev/stdin "$pkgdir/usr/bin/$_pkgname" <<'END'
#!/bin/sh
exec /usr/lib/firefox/firefox "$@"
END
  # Link binary
  ln -srf "$pkgdir/usr/bin/$_pkgname" "$pkgdir/usr/lib/$_pkgname/firefox-bin"
  # Link ONNX runtime if available
  if [[ -f /usr/lib/libonnxruntime.so ]]; then
    ln -srv /usr/lib/libonnxruntime.so "$pkgdir/usr/lib/$_pkgname/libonnxruntime.so" 2>/dev/null || : 
  fi
}

# vim: set sw=2 et:
