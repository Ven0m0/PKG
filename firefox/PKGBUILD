# Maintainer: Ven0m0
pkgname=firefox-custom
_pkgname=firefox
pkgver=145.0.1
pkgrel=1
pkgdesc='Firefox optimal build'
arch=(x86_64)
url="https://mozilla.org/firefox"
license=(MPL-2.0)
provides=("firefox=${pkgver}")
conflicts=('firefox')
depends=(
  alsa-lib at-spi2-core bash cairo dbus ffmpeg fontconfig freetype2
  gcc-libs gdk-pixbuf2 glib2 glibc gtk3 hicolor-icon-theme libevent
  libjpeg libpulse libvpx libwebp libx11 libxcb libxcomposite libxdamage
  libxext libxfixes libxrandr libxss libxt mime-types nss nspr pango
  ttf-font dbus-glib dav1d aom icu graphite
)
makedepends=(
  autoconf2.13 bindgen cargo cargo-make cbindgen clang clang-tools-extra
  cmake diffutils git git-cinnabar gtk-doc imake jack lld llvm mesa nasm
  ninja nodejs pkg-config python rust sed grep file unzip
  wasi-compiler-rt wasi-libc wasi-libc++ wasi-libc++abi
  xorg-server-xvfb yasm zip
)
optdepends=(
  'hunspell-en_US: Spell checking, American English'
  'libnotify: Notification integration'
  'networkmanager: Location detection via available WiFi networks'
  'onnxruntime: Local machine learning features'
  'speech-dispatcher: Text-to-Speech'
  'xdg-desktop-portal: Screensharing with Wayland'
  'libdbusmenu-gtk3: Global menu support'
  'profile-sync-daemon: Load browser profile into RAM'
)
options=(!strip !emptydirs !debug !makeflags !lto)
_repo=https://hg.mozilla.org/mozilla-unified
conflicts=('firefox')
provides=('firefox')
source=(
  "https://archive.mozilla.org/pub/firefox/releases/${pkgver}/source/firefox-${pkgver}.source.tar.xz"
  ${_pkgname}.desktop
  ${_pkgname}-symbolic.svg
)
sha256sums=('SKIP' 'SKIP' 'SKIP' 'SKIP')
# Tunables:
# : "${ENABLE_PGO:=1}"  -> run PGO (two-stage). You should run the instrumented build, exercise the browser to generate profiles, then rebuild.
# : "${ENABLE_BOLT:=1}" -> run llvm-bolt pass (requires llvm-bolt available in PATH)
: "${NATIVE_ARCH:=native}"
: "${ENABLE_POLLY:=1}"
# Build flags as arrays
_cflags=(-O3 -march=${NATIVE_ARCH} -mtune=${NATIVE_ARCH} -fomit-frame-pointer -ffunction-sections -fdata-sections -pipe -fno-plt -fno-semantic-interposition -fjump-tables)
_cppflags=("${_cflags[@]}")
_ldflags=(-Wl,-O3 -Wl,--gc-sections -Wl,--sort-common -Wl,--as-needed -Wl,-z,pack-relative-relocs -Wl,-z,relro -Wl,-z,now -flto -fuse-linker-plugin -Wl,-plugin-opt=emit-llvm)
_rustflags=(-Ctarget-cpu=native -Copt-level=3 -Clto=fat -Ccodegen-units=1 -Cpanic=abort -Clink-arg=-fuse-ld=lld -Cllvm-args=-enable-dfa-jump-thread )

prepare() {
  cd "$_pkgname-$pkgver"
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src == *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 -i "../$src" || :
  done
  # clear forced startup pages
  sed -E -e 's&^\s*pref\("startup\.homepage.*$&&' -i "browser/branding/official/pref/firefox-branding.js"
}

# Write a compact mozconfig to target minimal features
_write_mozconfig() {
  mkdir -p mozbuild
  cd "$_pkgname-$pkgver"
  cp browser/config/mozconfig ../mozconfig
  cat >>../mozconfig <<END
ac_add_options --enable-application=browser
mk_add_options MOZ_OBJDIR=${PWD@Q}/obj
export MOZ_APP_REMOTINGNAME=${pkgname}
export AR=llvm-ar
export CC=clang
export CXX=clang++
export NM=llvm-nm
export RANLIB=llvm-ranlib
ac_add_options --prefix=/usr
ac_add_options --enable-optimize="-O3 -march=native"
# Rust optimizations
ac_add_options OPT_LEVEL="3"
ac_add_options RUSTC_OPT_LEVEL="3"
export CARGO_PROFILE_RELEASE_OPT_LEVEL=3
# Parallel build optimization
mk_add_options MOZ_MAKE_FLAGS="-j$(nproc)" MOZ_PARALLEL_BUILD="$(nproc)"
# x86_64 optimizations
ac_add_options --disable-elf-hack
ac_add_options --enable-rust-simd
ac_add_options --enable-wasm-simd
ac_add_options --enable-wasm-avx
ac_add_options --enable-linker=lld
ac_add_options --with-ccache=sccache
ac_add_options --enable-lto=full
ac_add_options --enable-strip
ac_add_options --enable-install-strip
export STRIP_FLAGS="--strip-debug --strip-unneeded"
ac_add_options --enable-release
ac_add_options --enable-hardening
ac_add_options --disable-tests
ac_add_options --disable-debug
ac_add_options --disable-debug-symbols
ac_add_options --disable-debug-js-modules
ac_add_options --disable-crashreporter
ac_add_options --disable-updater
ac_add_options --disable-default-browser-agent
ac_add_options --disable-parental-controls
ac_add_options --enable-default-toolkit=cairo-gtk3-wayland
ac_add_options --enable-wayland
ac_add_options --with-wasi-sysroot=/usr/share/wasi-sysroot
ac_add_options --with-unsigned-addon-scopes=app,system
ac_add_options --allow-addon-sideload
ac_add_options --with-distribution-id=org.archlinux
ac_add_options --with-system-nspr
ac_add_options --with-system-nss
ac_add_options --with-system-libvpx
ac_add_options --with-system-webp
ac_add_options --with-system-libevent
ac_add_options --with-system-icu
ac_add_options --with-system-zlib
ac_add_options --with-system-jpeg
ac_add_options --enable-jxl
ac_add_options --enable-av1
ac_add_options --enable-pulseaudio
ac_add_options --enable-proxy-bypass-protection
ac_add_options --enable-eme=widevine
ac_add_options --enable-webrtc
ac_add_options --enable-alsa
ac_add_options --enable-jack
ac_add_options --disable-warnings-as-errors
mk_add_options MOZ_CRASHREPORTER=0
mk_add_options MOZ_DATA_REPORTING=0
export CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib
export MOZILLA_OFFICIAL=1 MOZ_NOSPAM=1 MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=pip MOZ_DEBUG_FLAGS=""

export CFLAGS+=" -g0"
export CXXFLAGS+=" -g0"
# might help with failing x86_64 builds?
export LDFLAGS+=" -Wl,--no-keep-memory"
export RUSTFLAGS="-Cdebuginfo=0 -Ctarget-cpu=native -Copt-level=3"
END
}

build() {
  cd "$_pkgname-$pkgver"
  _write_mozconfig
  git config remote.origin.mirror false 2>/dev/null || :
  ulimit -n 4096
  export CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib LD=ld.lld
  export RUST_MIN_STACK=16777216
  export PYTHONOPTIMIZE=2 RUSTC_WRAPPER=sccache CARGO_CACHE_RUSTC_INFO=1 OPT_LEVEL=3 CARGO_INCREMENTAL=0
  export MOZ_NOSPAM=1 MOZ_ENABLE_WAYLAND=1 LIBGL_ALWAYS_SOFTWARE=true
  CFLAGS="${_cflags[*]} ${CFLAGS:-}"
  CXXFLAGS="${_cflags[*]} ${CXXFLAGS:-}"
  # malloc_usable_size is used in various parts of the codebase
  CFLAGS="${CFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2}"
  CXXFLAGS="${CXXFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2}"
  # Breaks compilation since https://bugzilla.mozilla.org/show_bug.cgi?id=1896066
  CFLAGS="${CFLAGS/-fexceptions/}"
  CXXFLAGS="${CXXFLAGS/-fexceptions/}"
  LDFLAGS="${_ldflags[*]} ${LDFLAGS:-}"
  RUSTFLAGS="${_rustflags[*]} ${RUSTFLAGS:-}"
  export CFLAGS CXXFLAGS LDFLAGS RUSTFLAGS
  # Polly/Propeller opt-in
  [[ -n "${ENABLE_POLLY:-}" ]] && {
    export CFLAGS+=" -mllvm -polly -mllvm -polly-vectorizer=stripmine"
    export CXXFLAGS+=" -mllvm -polly -mllvm -polly-vectorizer=stripmine"
  }
  # PGO instrumentation build
  if [[ -n "${ENABLE_PGO:-}" ]]; then
    export CFLAGS+=" -fprofile-generate=profile_data"
    export CXXFLAGS+=" -fprofile-generate=profile_data"
    export RUSTFLAGS+=" -C profile-generate=profile_data"
    export LLVM_PROFDATA=llvm-profdata LIBGL_ALWAYS_SOFTWARE=true
    echo "PGO: instrumented build. After this completes, run the browser to generate profiles, then rebuild with ENABLE_PGO=use"
    cat >.mozconfig ../mozconfig - <<END
    ac_add_options --enable-profile-generate=cross
END
    dbus-run-session
  fi
  # clear forced startup pages
  sed -E -e 's&^\s*pref\("startup\.homepage.*$&&' \
    -i browser/branding/*/pref/firefox-branding.js
  # Configure / build via mach
  ./mach bootstrap --no-interactive --application-choice=browser || :
  ./mach build -j"$(nproc)" --priority normal || return 1
  # If running BOLT rewriting is requested and llvm-bolt exists, run on the main binaries
  if [[ -n "${ENABLE_BOLT:-}" ]] && command -v llvm-bolt >/dev/null 2>&1; then
    # Collect target binaries
    objdir=./obj-firefox/dist
    for bin in "$objdir"/firefox "$objdir"/libxul.so; do
      [[ -f "$bin" ]] || continue
      # Placeholder profile path; user should generate profile_data.prof by running instrumented binary
      prof=profile_data/merged.prof
      if [[ -f "$prof" ]]; then
        llvm-bolt "$bin" -o "${bin}.bolt" --data="$prof" || :
        mv -f "${bin}.bolt" "$bin" || :
      fi
    done
  fi
  # If PGO use-phase requested
  if [[ "${ENABLE_PGO:-}" == "use" ]]; then
    export CFLAGS="${_cflags[*]} -fprofile-use=profile_data -fprofile-correction"
    export CXXFLAGS="${_cppflags[*]} -fprofile-use=profile_data -fprofile-correction"
    export RUSTFLAGS="${_rustflags[*]} -C profile-use=profile_data"
    ./mach clobber || :
    ./mach build -j"$(nproc)" || return 1
  fi
}

package() {
  cd "$_pkgname-$pkgver"
  DESTDIR="$pkgdir" ./mach install
  install -Dm644 /dev/stdin "$pkgdir/usr/lib/$_pkgname/browser/defaults/preferences/vendor.js" <<END
pref("intl.locale.requested", "");
pref("spellchecker.dictionary_path", "/usr/share/hunspell");
pref("browser.shell.checkDefaultBrowser", false);
pref("image.jxl.enabled", true);
pref("extensions.autoDisableScopes", 11);
pref("extensions.shownSelectionUI", true);
pref("browser.aboutConfig.showWarning", false);
pref("datareporting.healthreport.uploadEnabled", false);
pref("datareporting.policy.dataSubmissionEnabled", false);
pref("toolkit.telemetry.enabled", false);
pref("toolkit.telemetry.unified", false);
pref("services.settings.main.search-telemetry-v2.last_check", $(date +%s));
pref("browser.ping-centre.telemetry", false);
pref("app.normandy.enabled", false);
pref("app.shield.optoutstudies.enabled", false);
pref("extensions.getAddons.showPane", false);
pref("extensions.htmlaboutaddons.recommendations.enabled", false);
pref("browser.discovery.enabled", false);
pref("browser.gnome-search-provider.enabled", true);
pref("services.settings.main.search-telemetry-v2.last_check", $(date +%s));
END
  install -Dm644 /dev/stdin "$pkgdir/usr/lib/$_pkgname/distribution/distribution.ini" <<END
[Global]
id=archlinux
version=1.0
about=Mozilla Firefox for Arch Linux
[Preferences]
app.distributor=archlinux
app.distributor.channel=$_pkgname
app.partner.archlinux=archlinux
END
  install -Dm644 /dev/stdin "$pkgdir/usr/share/gnome-shell/search-providers/$_pkgname.search-provider.ini" << END
[Shell Search Provider]
DesktopId=$_pkgname.desktop
BusName=org.mozilla.${_pkgname//-/}.SearchProvider
ObjectPath=/org/mozilla/${_pkgname//-/}/SearchProvider
Version=2
END
  for i in 16 22 24 32 48 64 128 256; do
    install -Dm644 browser/branding/official/default$i.png \
      "$pkgdir/usr/share/icons/hicolor/${i}x${i}/apps/$_pkgname.png"
  done
  install -Dm644 browser/branding/official/content/about-logo.png \
    "$pkgdir/usr/share/icons/hicolor/192x192/apps/$_pkgname.png"
  install -Dm644 browser/branding/official/content/about-logo@2x.png \
    "$pkgdir/usr/share/icons/hicolor/384x384/apps/$_pkgname.png"
  install -Dm644 ../$_pkgname-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/$_pkgname-symbolic.svg"
  install -Dm644 ../$_pkgname.desktop \
    "$pkgdir/usr/share/applications/$_pkgname.desktop"
  install -Dm755 /dev/stdin "$pkgdir/usr/bin/$_pkgname" <<'END'
#!/bin/sh
exec /usr/lib/firefox/firefox "$@"
END
  ln -srf "$pkgdir/usr/bin/$_pkgname" "$pkgdir/usr/lib/$_pkgname/firefox-bin"
  ln -sf "$_pkgname" "$pkgdir/$_install_path/$_pkgname/$_pkgname-bin"
}

# vim: ts=2 sw=2 et:
