# Maintainer:
# Contributor: Nick Lay <layns(at)mail(dot)uc(dot)edu>

## options
: ${_build_clang:=true}
: ${_branch=primehack-aur}
_projectname='dolphin'
_pkgname="$_projectname-emu"
pkgname="$_pkgname-git"
pkgver='2509.r528.gaeac5f1a58'
pkgrel=1
pkgdesc='A Gamecube / Wii emulator'
url="https://github.com/xiota/dolphin-primehack"
license=('GPL-2.0-or-later')
arch=('x86_64' 'aarch64')
depends=(
	# Based on the repo package
	'bluez-libs' 'bzip2' 'enet' 'gcc-libs' 'glibc' 'hidapi' 'libavcodec.so'
	'libavformat.so' 'libavutil.so' 'libcurl.so' 'libfmt.so' 'libgl'
	'libsfml-network.so' 'libsfml-system.so' 'libspng.so' 'libswscale.so'
	'libusb-1.0.so' 'libx11' 'libxi' 'libxrandr' 'lz4' 'lzo' 'mbedtls2' 'pugixml'
	'sdl3' 'sfml' 'speexdsp' 'xxhash' 'xz' 'zstd'
	# Additional dependencies to replace vendored deps
	'cubeb' 'glslang' 'libiconv' 'llvm' 'minizip-ng' 'zlib-ng'
)
makedepends=(
	'alsa-lib' 'cmake' 'git' 'libevdev' 'libminiupnpc.so' 'libpulse'
	'libudev.so' 'ninja' 'python' 'qt6-base' 'qt6-svg' 'vulkan-headers'
)
if [[ ${_build_clang::1} == "t" ]]; then
  makedepends+=(
    clang
    lld
    llvm
  )
else
  options+=('!lto')
fi
checkdepends=('gtest')
optdepends=('pulseaudio: PulseAudio backend')
provides=("$_pkgname")
conflicts=("$_pkgname")
options+=(!emptydirs)
_pkgsrc="xiota.primehack"
source=("$_pkgsrc"::"git+$url.git#branch=$_branch")
source=(
	"$pkgname::git+https://github.com/$_mainpkgname/$_projectname"
	"$pkgname-cppipc::git+https://github.com/mutouyun/cpp-ipc.git"
	"$pkgname-cppoptparse::git+https://github.com/weisslj/cpp-optparse.git"
	"$pkgname-imgui::git+https://github.com/ocornut/imgui.git"
	"$pkgname-implot::git+https://github.com/epezent/implot.git"
	"$pkgname-mgba::git+https://github.com/mgba-emu/mgba.git"
	"$pkgname-rcheevos::git+https://github.com/RetroAchievements/rcheevos.git"
	"$pkgname-tinygltf::git+https://github.com/syoyo/tinygltf.git"
	"$pkgname-vh::git+https://github.com/KhronosGroup/Vulkan-Headers.git"
	"$pkgname-vma::git+https://github.com/GPUOpen-LibrariesAndSDKs/VulkanMemoryAllocator.git"
	"$pkgname-watcher::git+https://github.com/e-dant/watcher.git"
)
b2sums=('SKIP'
        'SKIP'
        'SKIP'
        'SKIP'
        'SKIP'
        'SKIP'
        'SKIP'
        'SKIP'
        'SKIP'
        'SKIP'
        'SKIP')
_sourcedirectory="$pkgname"

prepare() {
  cd "$srcdir/$_sourcedirectory/"
  [[ -d 'build/' ]] && rm -rf 'build/'
  
  git rm -r 'Externals/FFmpeg-bin'
  git rm -r 'Externals/Qt'
  git rm -r 'Externals/SDL/SDL'
  git rm -r 'Externals/Vulkan-Headers'
  git rm -r 'Externals/curl/curl'
  git rm -r 'Externals/fmt/fmt'
  git rm -r 'Externals/gtest'
  git rm -r 'Externals/hidapi/hidapi-src'
  git rm -r 'Externals/libadrenotools'
  git rm -r 'Externals/libspng/libspng'
  git rm -r 'Externals/libusb/libusb'
  git rm -r 'Externals/lz4/lz4'
  git rm -r 'Externals/miniupnpc/miniupnp'
  git rm -r 'Externals/spirv_cross/SPIRV-Cross'
  # git submodule update --init --depth=1 --recursive
	# Provide submodules
	declare -A _submodules=(
		[cppipc]='cpp-ipc/cpp-ipc'
		[cppoptparse]='cpp-optparse/cpp-optparse'
		[imgui]='imgui/imgui'
		[implot]='implot/implot'
		[mgba]='mGBA/mgba'
		[rcheevos]='rcheevos/rcheevos'
		[tinygltf]='tinygltf/tinygltf'
		[vh]='Vulkan-Headers'
		[vma]='VulkanMemoryAllocator'
		[watcher]='watcher/watcher'
	)
	for _submod in "${!_submodules[@]}"; do
		_path="Externals/${_submodules[$_submod]}"
		git submodule init "$_path"
		git config "submodule.$_path.url" "$srcdir/$pkgbase-$_submod/"
		git -c protocol.file.allow=always submodule update --depth=1 "$_path"
	done
  # Delete gcc specific options
  sed '/_ARCHIVE_/d' -i CMakeLists.txt
  # Fix for Qt 6.10
  sed -E -e '/COMPONENTS/s&\b(Widgets)\b&\1 GuiPrivate&' \
    -e '$ a target_link_libraries(dolphin-emu PRIVATE Qt6::GuiPrivate)' \
    -i Source/Core/DolphinQt/CMakeLists.txt
  # HACK
  qpaheader=$(find /usr/include -type f -name 'qplatformnativeinterface.h' -print -quit)
  sed -i "s|#include <qpa/qplatformnativeinterface.h>|#include <$qpaheader>|" ./Source/Core/DolphinQt/MainWindow.cpp
}
pkgver() {
  cd "$srcdir/$_sourcedirectory/"
  git describe --long --tags | sed -e 's/-\([^-]*-g[^-]*\)$/-r\1/' -e 's/-/./g'
}

build() {
  cd "$srcdir/$_sourcedirectory/"
  export CC CXX CFLAGS CXXFLAGS LDFLAGS
  local _pkgver _cmake_options
  # Fix version string
  _pkgver=$(pkgver)
  install /dev/stdin "$srcdir/$_pkgsrc/Source/Core/Common/scmrev.h.in" <<END
#define SCM_REV_STR "\${DOLPHIN_WC_REVISION}"
#define SCM_DESC_STR "${_pkgver:?}"
#define SCM_BRANCH_STR "$_branch"
#define SCM_COMMITS_AHEAD_MASTER 0
#define SCM_DISTRIBUTOR_STR "aur.archlinux.org"
#define SCM_UPDATE_TRACK_STR ""
END
  # Optimized compiler flags
  export CFLAGS="${CFLAGS} -O3 -march=native -mtune=native -pipe -fno-plt"
  export CXXFLAGS="${CXXFLAGS} -O3 -march=native -mtune=native -pipe -fno-plt"
  export LDFLAGS="${LDFLAGS} -Wl,-O3,--sort-common,--as-needed,-z,relro,-z,now"
  _cmake_options=(
    -B build -G Ninja -S '.'
    -DCMAKE_BUILD_TYPE=Release
    -DCMAKE_INSTALL_PREFIX='/usr' -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    -DCMAKE_SKIP_RPATH=ON -DENABLE_AUTOUPDATE=OFF
    -DENABLE_ANALYTICS=OFF -DENCODE_FRAMEDUMPS=OFF -DUSE_DISCORD_PRESENCE=OFF
    -DUSE_SYSTEM_LIBS=ON -DUSE_SANITIZERS=OFF # cubeb
    -DUSE_SYSTEM_ENET=OFF -DUSE_SYSTEM_FMT=ON
    -DUSE_SYSTEM_LIBMGBA=OFF -DUSE_SYSTEM_XXHASH=OFF
    -DENABLE_TESTS=OFF -DENABLE_QT=ON -DENABLE_NOGUI=ON
    -DUSE_SYSTEM_CURL=ON -DUSE_SYSTEM_ICONV=ON
    -DUSE_SYSTEM_BZIP2=ON -DUSE_SYSTEM_LIBMGBA=OFF -Wno-dev
  )
  if [[ ${_build_clang::1} == "t" ]]; then
    CC=clang
    CXX=clang++
    LDFLAGS="$(sed -E -e 's/\S*fuse-ld\S*//g' <<<"$LDFLAGS") -fuse-ld=lld"
    _cmake_options+=(-DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON -DENABLE_LTO=ON)
  else
    _cmake_options+=(-DENABLE_LTO=OFF)
  fi
  cmake "${_cmake_options[@]}"
  cmake --build 'build/' -j"$(nproc)"
}
check() {
	# Get git version to compare
	cd "$srcdir/$_sourcedirectory/"
	_checkversion="$(git describe | cut --delimiter='-' --fields=1-2)"
	# Run tests
	cd "$srcdir/$_sourcedirectory/build/"
	ninja unittests
	# Verify that the basic functionality works
	_checkoutput="$(QT_QPA_PLATFORM='offscreen' "$srcdir/$_sourcedirectory/build/Binaries/$_noguipkgname" --version)"
	printf '%s\n' "$_checkoutput"
	printf '%s\n' "$_checkoutput" | grep -q -E "^${_projectname^}( \[.+\])? ${_checkversion}(-dirty)?(-ICC)?$"
}

package() {
  DESTDIR="${pkgdir}" cmake --install build
  install -Dm644 "${srcdir}/${_pkgsrc}/Data/51-usb-device.rules" "${pkgdir}/usr/lib/udev/rules.d/51-usb-device-primehack.rules"
  rm -rf "${pkgdir}"/usr/{include,lib/libdiscord-rpc.a}
}

package_dolphin-emu-git() {
	pkgdesc="$pkgdesc$_pkgdescappend"
	depends+=(
		'alsa-lib' 'hicolor-icon-theme' 'libevdev' 'libminiupnpc.so' 'libpulse'
		'libudev.so' 'qt6-base' 'qt6-svg'
	)
	provides=("$_mainpkgname")
	conflicts=("$_mainpkgname")
	cd "$srcdir/$_sourcedirectory/"
	DESTDIR="$pkgdir" cmake --install 'build/'
	install -Dm644 'Data/51-usb-device.rules' "$pkgdir/usr/lib/udev/rules.d/51-usb-device.rules"
	rm -rf "$pkgdir/usr/bin/$_noguipkgname"
	rm -rf "$pkgdir/usr/bin/$_projectname-tool"
	rm -rf "$pkgdir/usr/share/man/man6/$_noguipkgname.6"
}
package_dolphin-emu-nogui-git() {
	pkgdesc="$pkgdesc - no GUI$_pkgdescappend"
	depends+=("$_mainpkgname")
	optdepends=()
	provides=("$_noguipkgname" "$_mainpkgname-cli")
	conflicts=("$_noguipkgname" "$_mainpkgname-cli")
	cd "$srcdir/$_sourcedirectory/"
	install -Dm755 "$srcdir/$_sourcedirectory/build/Binaries/$_noguipkgname" "$pkgdir/usr/bin/$_noguipkgname"
	ln -sf "/usr/bin/$_noguipkgname" "$pkgdir/usr/bin/$_mainpkgname-cli"
	install -Dm644 "Data/$_noguipkgname.6" "$pkgdir/usr/share/man/man6/$_noguipkgname.6"
}
package_dolphin-emu-tool-git() {
	pkgdesc="$pkgdesc - CLI-based utility for functions such as managing disc images$_pkgdescappend"
	depends+=(
		'alsa-lib' 'libevdev' 'libpulse' 'libudev.so' 'qt6-base'
	)
	provides=("$_toolpkgname")
	conflicts=("$_toolpkgname")
	cd "$srcdir/$_sourcedirectory/"
	install -Dm755 "$srcdir/$_sourcedirectory/build/Binaries/$_projectname-tool" "$pkgdir/usr/bin/$_projectname-tool"
}
