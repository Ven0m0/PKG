# Maintainer: Ven0m0
# Based on: https://archlinux.org/packages/extra/x86_64/ffmpeg/
# Based on: https://github.com/jellyfin/jellyfin-ffmpeg

_pkgname=ffmpeg
pkgname=ffmpeg-opt
pkgver=7.1
pkgrel=1
pkgdesc='Complete solution to record, convert and stream audio and video - optimized build'
arch=(x86_64)
url='https://ffmpeg.org'
license=('GPL-3.0-only')
depends=(
  alsa-lib aribb24 bzip2 cairo expat fontconfig
  freetype2 fribidi glib2 glibc gmp gnutls gsm
  harfbuzz jack lame libass libavc1394 libbluray libbs2b
  libdrm libdvdnav libdvdread libgl libiec61883 libjpeg-turbo
  libmodplug libopenmpt libpng libpulse libraw1394 librsvg
  libsoxr libva libvdpau libwebp libx11 libxcb libxext
  libxv ocl-icd onevpl opencore-amr openjpeg2 opus
  sdl2 snappy speex v4l-utils vapoursynth xvidcore
  xz zimg zlib
  aom dav1d rav1e svt-av1
  libplacebo libtheora libvpx libxml2 rubberband vid.stab vmaf
  x264 x265
)
makedepends=(
  avisynthplus clang nasm git ladspa cmake
  libgl mesa opencl-headers vulkan-headers ffnvcodec-headers
  lv2 gmp patch
)
optdepends=(
  'avisynthplus: AviSynthPlus support'
  'frei0r-plugins: Frei0r video effects support'
  'intel-compute-runtime: for Intel OpenCL runtime based tonemapping'
  'intel-media-sdk: Intel QuickSync support (legacy)'
  'onevpl-intel-gpu: for Intel Quick Sync Video (Alder Lake and newer)'
  'ladspa: LADSPA filters'
  'nvidia-utils: Nvidia NVDEC/NVENC support'
  'vulkan-intel: for Intel ANV Vulkan support'
)
provides=("ffmpeg=$pkgver" 'libavcodec.so' 'libavdevice.so' 'libavfilter.so'
          'libavformat.so' 'libavutil.so' 'libswresample.so' 'libswscale.so')
conflicts=('ffmpeg')
options=(!lto)
source=(
  "https://ffmpeg.org/releases/ffmpeg-${pkgver}.tar.xz"
)
sha256sums=('SKIP')

prepare() {
  cd "$srcdir/$_pkgname-$pkgver"

  # Apply patches if any
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src == *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 -i "$srcdir/$src"
  done
}

build() {
  cd "$srcdir/$_pkgname-$pkgver"

  # Compiler settings for optimization
  export CFLAGS="-O3 -march=native -mtune=native -pipe -fno-plt -fexceptions \
-Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \
-fstack-clash-protection -fcf-protection"
  export CXXFLAGS="${CFLAGS}"
  export LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"

  ./configure \
    --prefix=/usr \
    --disable-debug \
    --disable-static \
    --disable-stripping \
    --enable-shared \
    --enable-gpl \
    --enable-version3 \
    --enable-nonfree \
    --enable-lto \
    --enable-fontconfig \
    --enable-gmp \
    --enable-gnutls \
    --enable-ladspa \
    --enable-libaom \
    --enable-libaribb24 \
    --enable-libass \
    --enable-libbluray \
    --enable-libbs2b \
    --enable-libdav1d \
    --enable-libdrm \
    --enable-libdvdnav \
    --enable-libdvdread \
    --enable-libfreetype \
    --enable-libfribidi \
    --enable-libgsm \
    --enable-libiec61883 \
    --enable-libjack \
    --enable-libjxl \
    --enable-libmodplug \
    --enable-libmp3lame \
    --enable-libopencore_amrnb \
    --enable-libopencore_amrwb \
    --enable-libopenjpeg \
    --enable-libopenmpt \
    --enable-libopus \
    --enable-libplacebo \
    --enable-libpulse \
    --enable-librav1e \
    --enable-librsvg \
    --enable-librubberband \
    --enable-libsnappy \
    --enable-libsoxr \
    --enable-libspeex \
    --enable-libssh \
    --enable-libsvtav1 \
    --enable-libtheora \
    --enable-libv4l2 \
    --enable-libvidstab \
    --enable-libvmaf \
    --enable-libvorbis \
    --enable-libvpl \
    --enable-libvpx \
    --enable-libwebp \
    --enable-libx264 \
    --enable-libx265 \
    --enable-libxcb \
    --enable-libxml2 \
    --enable-libxvid \
    --enable-libzimg \
    --enable-nvdec \
    --enable-nvenc \
    --enable-opencl \
    --enable-opengl \
    --enable-vapoursynth \
    --enable-vaapi \
    --enable-vdpau \
    --enable-vulkan

  make
  make tools/qt-faststart
}

package() {
  cd "$srcdir/$_pkgname-$pkgver"

  make DESTDIR="$pkgdir" install
  install -Dm755 tools/qt-faststart "$pkgdir/usr/bin/qt-faststart"
}

# vim: ts=2 sw=2 et:
