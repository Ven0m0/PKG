# Maintainer: Ven0m0
# Based on: https://archlinux.org/packages/extra/x86_64/ffmpeg/
# Based on: https://github.com/jellyfin/jellyfin-ffmpeg
# Optimizations from: https://github.com/Ven0m0/FFmpeg-Builds

_pkgname=ffmpeg
pkgname=ffmpeg-opt
pkgver=8.0.1
pkgrel=1
pkgdesc='Complete solution to record, convert and stream audio and video - optimized build with enhanced SVT-AV1 support'
arch=(x86_64)
url='https://ffmpeg.org'
license=('GPL-3.0-only')
depends=(
  alsa-lib aribb24 bzip2 cairo expat fontconfig
  freetype2 fribidi glib2 glibc gmp gnutls gsm
  harfbuzz jack lame libass libavc1394 libbluray libbs2b
  libdrm libdvdnav libdvdread libgl libiec61883 libjpeg-turbo
  libmodplug libopenmpt libpng libpulse libraw1394 librsvg
  libsoxr libssh libva libvdpau libwebp libx11 libxcb libxext
  libxv ocl-icd onevpl opencore-amr openjpeg2 opus
  sdl2 snappy speex v4l-utils vapoursynth xvidcore
  xz zimg zlib
  aom dav1d rav1e svt-av1
  libplacebo libtheora libvorbis libvpx libxml2 rubberband vid.stab vmaf
  x264 x265 libjxl
)
makedepends=(
  avisynthplus clang lld nasm git ladspa cmake
  libgl mesa opencl-headers vulkan-headers ffnvcodec-headers
  lv2 gmp patch
)
optdepends=(
  'avisynthplus: AviSynthPlus support'
  'frei0r-plugins: Frei0r video effects support'
  'intel-compute-runtime: for Intel OpenCL runtime based tonemapping'
  'intel-media-sdk: Intel QuickSync support (legacy)'
  'onevpl-intel-gpu: for Intel Quick Sync Video (Alder Lake and newer)'
  'ladspa: LADSPA filters'
  'nvidia-utils: Nvidia NVDEC/NVENC support'
  'vulkan-intel: for Intel ANV Vulkan support'
)
provides=("ffmpeg=$pkgver" 'libavcodec.so' 'libavdevice.so' 'libavfilter.so'
  'libavformat.so' 'libavutil.so' 'libswresample.so' 'libswscale.so')
conflicts=('ffmpeg')
options=('strip')
source=(
  "https://ffmpeg.org/releases/ffmpeg-${pkgver}.tar.xz"
)
sha256sums=('05ee0b03119b45c0bdb4df654b96802e909e0a752f72e4fe3794f487229e5a41')

prepare() {
  cd "$_pkgname-$pkgver"
  # Apply patches if any
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src == *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 -i "../$src"
  done
}

build() {
  cd "$_pkgname-$pkgver"
  # Use clang/lld for better optimization and faster linking
  export CC=clang
  export CXX=clang++
  export LD=lld

  # Use sccache if available for faster compilation
  if command -v sccache &>/dev/null; then
    export CC="sccache clang"
    export CXX="sccache clang++"
  fi

  # Compiler settings for optimization (based on FFmpeg-Builds optimizations)
  # -O3: Maximum optimization level for performance
  # -march=native: Optimize for current CPU architecture (enables AVX512 if available)
  # -mtune=native: Tune for current CPU microarchitecture
  # -pipe: Use pipes instead of temporary files for compilation
  # -fno-plt: Avoid PLT for better performance with shared libraries
  # -flto=auto: Link-time optimization with auto-parallelization
  # -fstack-protector-strong: Enhanced stack protection against buffer overflows
  # -fstack-clash-protection: Protection against stack clash attacks
  # -fcf-protection: Control-flow protection (Intel CET)
  # -fvisibility=hidden: Hide symbols by default (reduces binary size)
  # -fno-semantic-interposition: Allow more aggressive optimizations
  # -D_FORTIFY_SOURCE=2: Runtime buffer overflow detection
  export CFLAGS="-O3 -march=native -mtune=native -pipe -fno-plt -flto=auto -fexceptions -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security -fstack-clash-protection -fstack-protector-strong -fcf-protection -fvisibility=hidden -fno-semantic-interposition" CXXFLAGS="$CFLAGS" LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now -flto=auto -fuse-ld=lld"
  ./configure --prefix=/usr --disable-debug --disable-static --disable-stripping --enable-shared --enable-gpl --enable-version3 --enable-nonfree --enable-lto \
    --enable-fontconfig --enable-gmp --enable-gnutls --enable-ladspa --enable-libaom --enable-libaribb24 --enable-libass --enable-libbluray \
    --enable-libbs2b --enable-libdav1d --enable-libdrm --enable-libdvdnav --enable-libdvdread --enable-libfreetype --enable-libfribidi \
    --enable-libgsm --enable-libiec61883 --enable-libjack --enable-libjxl --enable-libmodplug --enable-libmp3lame --enable-libopencore_amrnb \
    --enable-libopencore_amrwb --enable-libopenjpeg --enable-libopenmpt --enable-libopus --enable-libplacebo --enable-libpulse --enable-librav1e \
    --enable-librsvg --enable-librubberband --enable-libsnappy --enable-libsoxr --enable-libspeex --enable-libssh --enable-libsvtav1 --enable-libtheora \
    --enable-libv4l2 --enable-libvidstab --enable-libvmaf --enable-libvorbis --enable-libvpl --enable-libvpx --enable-libwebp --enable-libx264 \
    --enable-libxcb --enable-libxml2 --enable-libxvid --enable-libzimg --enable-nvdec --enable-nvenc --enable-opencl --enable-opengl --enable-vapoursynth \
    --enable-vaapi --enable-vdpau --enable-vulkan
  make -j"$(nproc)"
  make tools/qt-faststart
  rm -fv ./*-docs-*.pkg.tar.* ./*-debug-*.pkg.tar.*
}

package() {
  cd "$_pkgname-$pkgver"
  make DESTDIR="$pkgdir" install
  install -Dm755 tools/qt-faststart "$pkgdir/usr/bin/qt-faststart"
}

# vim: ts=2 sw=2 et:
