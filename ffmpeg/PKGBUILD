pkgname=ffmpeg-opt
arch=(x86_64)
url=https://ffmpeg.org

depends=(
  alsa-lib aom aribb24 bzip2 cairo dav1d expat fontconfig
  freetype2 fribidi glib2 glibc glslang gmp gnutls gsm
  harfbuzz jack lame libass libavc1394 libbluray libbs2b
  libdrm libdvdnav libdvdread libgl libiec61883 libjpeg-turbo
  libjxl libmodplug libopenmpt libplacebo libpng libpulse
  libraw1394 librsvg libsoxr libtheora libva libvdpau
  libvpx libwebp libx11 libx264 libxcb libxext opus
  libxml2 libxv ocl-icd onevpl opencore-amr openjpeg2 
  rubberband sdl2 snappy speex xvidcore v4l-utils
  vapoursynth vid.stab vmaf vulkan-icd-loader x264
  xz zimg zlib rav1e svt-av1
)
makedepends=(amf-headers avisynthplus clang nasm frei0r-plugins
  git ladspa mesa ffnvcodec-headers opencl-headers vulkan-headers)
optdepends=(
  'avisynthplus: AviSynthPlus support'
  'frei0r-plugins: Frei0r video effects support'
  'intel-media-sdk: Intel QuickSync support (legacy)'
  'ladspa: LADSPA filters'
  'nvidia-utils: Nvidia NVDEC/NVENC support'
  'onevpl-intel-gpu: Intel QuickSync support')
provides=('libavcodec.so' 'libavdevice.so' 'libavfilter.so' 
  'libavformat.so' 'libavutil.so' 'libswresample.so' 'libswscale.so')
source=('git+https://git.ffmpeg.org/ffmpeg.git?signed#tag=${_tag}#depth=1'
  0001-Add-av_stream_get_first_dts-for-Chromium.patch
  0001-unbreak-glslang-build.patch
)
prepare() {
  cd $pkgdir
  echo "add SVT-VP9 (https://github.com/OpenVisualCloud/SVT-VP9)"
  git clone --depth 1 https://github.com/OpenVisualCloud/SVT-VP9.git
  # Adjust this line to add any other cmake related options
  export CFLAGS="$CFLAGS -flto=auto -Wno-incompatible-pointer-types" CXXFLAGS="$CXXFLAGS -flto=auto" LDFLAGS="$LDFLAGS -flto=auto"
  CMAKE_EXTRA_FLAGS="-DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DBUILD_SHARED_LIBS=ON ${CMAKE_EXTRA_FLAGS:-}"
  export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/lib
  export PKG_CONFIG_PATH=${PKG_CONFIG_PATH}:/usr/local/lib/pkgconfig
  git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg
  git apply --whitespace=fix ../ffmpeg_plugin/master-0001-Add-ability-for-ffmpeg-to-run-svt-vp9.patch

  echo "add SVT-HEVC (https://github.com/OpenVisualCloud/SVT-HEVC)"
  git am --whitespace=fix ../SVT-HEVC/ffmpeg_plugin/master-0001-lavc-svt_hevc-add-libsvt-hevc-encoder-wrapper.patch
  git am ../SVT-HEVC/ffmpeg_plugin/0002-doc-Add-libsvt_hevc-encoder-docs.patch
  ./configure --enable-libsvthevc
}
build() {
  ./configure --enable-libsvtvp9 --enable-avcodec --enable-libdav1d --enable-libaom --enable-libjxl \
    --enable-libdvdread --enable-libfontconfig --enable-libfreetype --enable-gmp --enable-libopus --enable-libsvtav1 \
    --enable-libwebp --enable-libvpx --enable-vulkan --enable-vdpau --enable-vaapi --enable-vapoursynth --enable-zlib \
    --enable-xlib 3 --enable-shared --enable-openssl  --enable-opengl --enable-opencl --enable-openal \
    --enable-nonfree --enable-lzma --enable-lv2 --enable-libdrm --enable-cuda-llvm \
    --enable-cuvid --enable-ffnvcodec --enable-cuda-nvcc --enable-libsvtvp9 --enable-libvmaf --enable-libvpl \
    --disable-example --disable-lavf --enable-libzimg --disable-symbol-versions --without-python

    --disable-doc --enable-lto --enable-version --enable-nvdec --enable-nvenc
    --enable-wayland --enable-drm --enable-shared -Dradeon=disabled -Damdgpu=disabled -Dnouveau=disabled \
    -Dcairo-tests=disabled -Dexynos=disabled --buildtype=release -Dzlib=enabled --enable-nasm \
    --disable-gtktest --disable-oggtest --disable-vorbistest --disable-unit-tests --disable-libx265



  make -j $(nproc)
  make install
}

package() {
  install -Dm 755 bin/ffdetect "${pkgdir}"/usr/bin/ffdetect
  install -Dm 755 ffmpeg-${pkgver}_public/ffmpeg "${pkgdir}"/usr/bin/ffmpeg
  install -Dm 755 ffmpeg-${pkgver}_public/ffprobe "${pkgdir}"/usr/bin/ffprobe
}

# vim: ts=2 sw=2 et:
