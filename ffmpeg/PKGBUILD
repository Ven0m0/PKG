_pkgname=ffmpeg-opt
pkgname=ffmpeg
pkgver=8.0
pkgrel=3
epoch=2
arch=(x86_64)
url=https://ffmpeg.org
pkgdesc='Ven0m0s build of ffmpeg'
license=('GPL-3.0-only')
depends=(
  alsa-lib aom aribb24 bzip2 cairo dav1d expat fontconfig
  freetype2 fribidi glib2 glibc glslang gmp gnutls gsm
  harfbuzz jack lame libass libavc1394 libbluray libbs2b
  libdrm libdvdnav libdvdread libgl libiec61883 libjpeg-turbo
  libjxl libmodplug libopenmpt libplacebo libpng libpulse
  libraw1394 librsvg libsoxr libtheora libva libvdpau
  libvpx libwebp libx11 libx264 libxcb libxext opus
  libxml2 libxv ocl-icd onevpl opencore-amr openjpeg2 
  rubberband sdl2 snappy speex xvidcore v4l-utils
  vapoursynth vid.stab vmaf vulkan-icd-loader x264
  xz zimg zlib rav1e svt-av1
)
makedepends=(avisynthplus clang nasm git ladspa
  mesa ffnvcodec-headers opencl-headers vulkan-headers)
optdepends=(
  'avisynthplus: AviSynthPlus support'
  'frei0r-plugins: Frei0r video effects support'
  'intel-compute-runtime: for Intel OpenCL runtime based tonemapping'
  'intel-media-sdk: Intel QuickSync support (legacy)'
  'onevpl-intel-gpu: for Intel Quick Sync Video (Alder Lake and newer)'
  'ladspa: LADSPA filters'
  'nvidia-utils: Nvidia NVDEC/NVENC support'
  'onevpl-intel-gpu: Intel QuickSync support'
  'vulkan-intel: for Intel ANV Vulkan support')
provides=('libavcodec.so' 'libavdevice.so' 'libavfilter.so' 
  'libavformat.so' 'libavutil.so' 'libswresample.so' 'libswscale.so')
source=("$pkgname::git+https://git.ffmpeg.org/${pkgname}.git#tag=v${pkgver/p/-}#depth=1"
  "https://gitlab.archlinux.org/archlinux/packaging/packages/ffmpeg/-/blob/2-8.0-3/0001-Add-av_stream_get_first_dts-for-Chromium.patch"
  "https://gitlab.archlinux.org/archlinux/packaging/packages/ffmpeg/-/blob/2-8.0-3/0001-unbreak-glslang-build.patch"
  "https://gitlab.archlinux.org/archlinux/packaging/packages/emby-ffmpeg/-/blob/main/06c2a2c425f22e7dba5cad909737a631cc676e3f.patch"
  "https://gitlab.archlinux.org/archlinux/packaging/packages/emby-ffmpeg/-/blob/main/mbedtls-3.6.patch"
)
options=('!lto')
noextract=(readme.md)

prepare() {
  cd "$pkgname"
  # https://crbug.com/1251779
  git apply -3 ../0001-Add-av_stream_get_first_dts-for-Chromium.patch
  # https://github.com/FFmpeg/FFmpeg/commit/f1e9032a2000b8b885cffd6fed8eacd47b37673f
  git apply -3 ../0001-unbreak-glslang-build.patch

  # apply patches
  #for i in patches/*.patch; do patch -Np1 -i -- "$i"; done
  
  echo "add SVT-VP9 (https://github.com/OpenVisualCloud/SVT-VP9)"
  git clone --depth 1 https://github.com/OpenVisualCloud/SVT-VP9.git
  # Adjust this line to add any other cmake related options
  export CFLAGS="$CFLAGS -flto=auto -Wno-incompatible-pointer-types" CXXFLAGS="$CXXFLAGS -flto=auto" LDFLAGS="$LDFLAGS -flto=auto"
  CMAKE_EXTRA_FLAGS="-DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DBUILD_SHARED_LIBS=ON ${CMAKE_EXTRA_FLAGS:-}"
  export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/lib
  export PKG_CONFIG_PATH=${PKG_CONFIG_PATH}:/usr/local/lib/pkgconfig
  git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg
  git apply --whitespace=fix ../ffmpeg_plugin/master-0001-Add-ability-for-ffmpeg-to-run-svt-vp9.patch

  echo "add SVT-HEVC (https://github.com/OpenVisualCloud/SVT-HEVC)"
  git am --whitespace=fix ../SVT-HEVC/ffmpeg_plugin/master-0001-lavc-svt_hevc-add-libsvt-hevc-encoder-wrapper.patch
  git am ../SVT-HEVC/ffmpeg_plugin/0002-doc-Add-libsvt_hevc-encoder-docs.patch
  ./configure --enable-libsvthevc
}
build() {
  cd "$pkgname"
  CFLAGS+=" -Wno-incompatible-pointer-types"
  ./configure --enable-libsvtvp9 --enable-avcodec --enable-libdav1d --enable-libaom --enable-libjxl \
    --enable-libdvdread --enable-libfontconfig --enable-libfreetype --enable-gmp --enable-libsvtav1 \
    --enable-libwebp --enable-libvpx --enable-vulkan --enable-vdpau --enable-vaapi --enable-vapoursynth --enable-zlib \
    --enable-xlib --enable-shared --enable-openssl  --enable-opengl --enable-opencl --enable-openal \
    --enable-nonfree --enable-lzma --enable-lv2 --enable-libdrm --enable-cuda-llvm \
    --enable-cuvid --enable-ffnvcodec --enable-cuda-nvcc --enable-libsvtvp9 --enable-libvmaf --enable-libvpl \
    --disable-example --disable-lavf --enable-libzimg --disable-symbol-versions --without-python --enable-version3

    --disable-doc --enable-lto --enable-version --enable-nvdec --enable-nvenc --target-os=linux
    --enable-wayland --enable-drm --enable-shared -Dradeon=disabled -Damdgpu=disabled -Dnouveau=disabled --disable-amf \
    -Dcairo-tests=disabled -Dexynos=disabled --buildtype=release -Dzlib=enabled --enable-nasm \
    --disable-gtktest --disable-oggtest --disable-vorbistest --disable-unit-tests --disable-libx265 \
    --disable-libvorbis --enable-libopus --disable-librtmp --prefix=/usr --disable-debug

  make -j $(nproc)
  #make -j $(nproc) tools/qt-faststart
  #make -j $(nproc) doc/ff{mpeg,play}.1
}

package() {
  #depends+=(libass.so libbluray.so libbs2b.so libdav1d.so librav1e.so libjxl.so
    #libfreetype.so libharfbuzz.so libopenmpt.so libplacebo.so librsvg-2.so 
    #librubberband.so libva.so libva-drm.so libzimg.so libzmq.so
    #libvidstab.so libvpx.so libx264.so libxvidcore.so)
  #make -j $(nproc) DESTDIR="${pkgdir}" -C ffmpeg install install-man
  #install -Dm 755 ffmpeg/tools/qt-faststart "${pkgdir}"/usr/bin/
  
  cd "${pkgname:-$pkgdir)"
  install -Dm 755 bin/ffdetect "${pkgdir}"/usr/bin/ffdetect
  install -Dm 755 ffmpeg-${pkgver}_public/ffmpeg "${pkgdir}"/usr/bin/ffmpeg
  install -Dm 755 ffmpeg-${pkgver}_public/ffprobe "${pkgdir}"/usr/bin/ffprobe
}

# vim: ts=2 sw=2 et:
